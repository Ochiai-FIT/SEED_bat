REM [140][BFB01]
@ECHO OFF

REM ログフォルダ作成
IF NOT EXIST %~DP0..\logs MKDIR %~DP0..\logs

REM コマンドフォルダ作成
IF NOT EXIST %~DP0..\cmd MKDIR %~DP0..\cmd

REM ログファイルの情報
SET OUTFILE=%~DP0../logs/setup.log
SET OUTTIME=%~DP0../logs/time.log

REM ベースフォルダ
SET BASEDIR=%~DP0..

REM 更新対象の情報
SET INFOSCRIPT=%~DP0..\cmd\%~N0.DB2


SET MSG=%DATE% %TIME% INAWK.ANWK14_TN06_A + INAWK.TMWK_A11TC34 → INAWK.ANWK14_TN06R ロード処理（定量特売納入日データ(冷食展開)テーブル作成）
ECHO %MSG%
>> %OUTFILE% ECHO %MSG%
"%MYSQLPATH%mysql" %OPTION% -h %HOST% %DB_NAME% -u %USER_ID% --show-warnings -vv -e "TRUNCATE TABLE INAWK.ANWK14_TN06R_A;INSERT IGNORE INTO INAWK.ANWK14_TN06R_A WITH A11TC34 AS (SELECT T1.BMNCD, T1.WRITUKBN, T1.DUMMYCD, T1.SHNCD, T1.HBSTDT, T1.HBEDDT, T1.SEIKI_CUT, T1.KANRINO, MAX(T1.MAKERKN) AS MAKERKN, MAX(T1.SHNKN) AS SHNKN, MAX(T1.KIKKN) AS KIKKN, MAX(T1.IRISU) AS IRISU, MAX(T1.BAIKAAM) AS BAIKAAM, MAX(T1.GENKAAM) AS GENKAAM, MAX(T2.HBSTDT) AS HBSTDT_BF, MAX(T2.HBEDDT) AS HBEDDT_BF FROM INAWK.TMWK_A11TC34 T1 LEFT OUTER JOIN INAWK.TMWK_A11TC34 T2 ON T1.BMNCD = T2.BMNCD AND T1.WRITUKBN = T2.WRITUKBN AND T1.DUMMYCD = T2.DUMMYCD AND T1.SHNCD = T2.SHNCD AND T1.HBSTDT > T2.HBSTDT GROUP BY T1.BMNCD, T1.WRITUKBN, T1.DUMMYCD, T1.SHNCD, T1.HBSTDT, T1.HBEDDT, T1.SEIKI_CUT, T1.KANRINO) SELECT SHOHINCD, FILLER_01, SHOHIN_KBN, BINKBN, NOU_SDATE, NOU_EDATE, HAN_SDATE, HAN_EDATE, NOU_DATE, NOU_DATEYB, HACHU_DATE, HACHU_DATEYB, GEN_TOKJIZEN, TUIKA_GENKA, PACK_GENKA, GEN_1KG, A_BAI_100G, B_BAI_100G, C_BAI_100G, A_BAI_PACK, B_BAI_PACK, C_BAI_PACK, A_BAI_1KG, B_BAI_1KG, C_BAI_1KG, A_BAI_100GS, B_BAI_100GS, C_BAI_100GS, AVGPTANKA, IRISU, TENSUU_BL1, TENSUU_BL2, A_BAI_1URI, A_BAI_BL1, A_BAI_BL2, B_BAI_1URI, B_BAI_BL1, B_BAI_BL2, C_BAI_1URI, C_BAI_BL1, C_BAI_BL2, SIRECD, NENMATSU, TEIKBN, TRTEISEK, TTKBN, KZKBN, FUTEIKBN, BETUDEN_KBN, WAPPEN, IKKATK, JIZNUT, SIDENF, TEICUTK, HOUZAI, DSEIK, PCKBN, HIGAWARI_KBN, HGENBAIKA_FLG, REI_DMY_FLG, UPDKBN, SEISUR, HENSUR, SEITK, NONSJ, ATARA, RDHMHYO, RDHMMON, RDHMTUE, RDHMWED, RDHMTHU, RDHMFRI, RDHMSAT, RDHMSUN, NONSU, BUMNCD, DAIBUNCD, CHUBUNCD, SHOBUNCD, SSBUNCD, MSSIRE, MSIR, MSIKK, MSWAP, MSBIN, EVENT_KBN, EVENT_SDATE, EVENT_SEQ, BUMN, KANRI_NO, EVENT_EDANO, WEEK_NO, SMISECD, KZCUT, KOUCUT, TEICUT, TOKCUT, KYUCUT, HACCUT, NONCUT, HSSCUT, ZEROCUT, FILLER_02, SYORIK, TOK_COMMENT, KIKAKU, SANCHI, JIZEN_DATE, JH_LIST_DATE, JH_TORI_DATE, WEEK_HDATE, TAISYO_TEN_RANK, TEN_HSUU_TBL, FILLER_03, SAKUSEI, DATA_KBN FROM (SELECT ROW_NUMBER() OVER (PARTITION BY WK.EVENT_KBN, WK.EVENT_SDATE, WK.EVENT_SEQ, WK.BUMN, WK.KANRI_NO, WK.EVENT_EDANO, WK.NOU_DATE, WK.HAN_SDATE, CASE WHEN RSHNA.BMNCD IS NOT NULL THEN RSHNA.SHNCD WHEN RSHNB.BMNCD IS NOT NULL THEN RSHNB.SHNCD WHEN RSHNC.BMNCD IS NOT NULL THEN RSHNC.SHNCD ELSE WK.SHOHINCD END ORDER BY CASE WHEN RSHNA.BMNCD IS NOT NULL THEN RSHNA.HBSTDT WHEN RSHNB.BMNCD IS NOT NULL THEN RSHNB.HBSTDT WHEN RSHNC.BMNCD IS NOT NULL THEN RSHNC.HBSTDT ELSE WK.HAN_SDATE END) AS RNO, CASE WHEN RSHNA.BMNCD IS NOT NULL THEN RSHNA.SHNCD WHEN RSHNB.BMNCD IS NOT NULL THEN RSHNB.SHNCD WHEN RSHNC.BMNCD IS NOT NULL THEN RSHNC.SHNCD ELSE WK.SHOHINCD END AS SHOHINCD, WK.FILLER_01, WK.SHOHIN_KBN, 1 AS BINKBN, WK.NOU_SDATE, WK.NOU_EDATE, WK.HAN_SDATE, WK.HAN_EDATE, WK.NOU_DATE, WK.NOU_DATEYB, WK.HACHU_DATE, WK.HACHU_DATEYB, CASE WHEN RSHNA.BMNCD IS NOT NULL THEN RSHNA.GENKAAM WHEN RSHNB.BMNCD IS NOT NULL THEN RSHNB.GENKAAM WHEN RSHNC.BMNCD IS NOT NULL THEN RSHNC.GENKAAM ELSE WK.GEN_TOKJIZEN END AS GEN_TOKJIZEN, CASE WHEN RSHNA.BMNCD IS NOT NULL THEN RSHNA.GENKAAM WHEN RSHNB.BMNCD IS NOT NULL THEN RSHNB.GENKAAM WHEN RSHNC.BMNCD IS NOT NULL THEN RSHNC.GENKAAM ELSE WK.TUIKA_GENKA END AS TUIKA_GENKA, WK.PACK_GENKA, WK.GEN_1KG, CASE WHEN RSHNA.BMNCD IS NOT NULL THEN RSHNA.BAIKAAM WHEN RSHNB.BMNCD IS NOT NULL THEN 0 WHEN RSHNC.BMNCD IS NOT NULL THEN 0 ELSE WK.A_BAI_100G END AS A_BAI_100G, CASE WHEN RSHNB.BMNCD IS NOT NULL THEN RSHNB.BAIKAAM WHEN RSHNA.BMNCD IS NOT NULL THEN 0 WHEN RSHNC.BMNCD IS NOT NULL THEN 0 ELSE WK.B_BAI_100G END AS B_BAI_100G, CASE WHEN RSHNC.BMNCD IS NOT NULL THEN RSHNC.BAIKAAM WHEN RSHNA.BMNCD IS NOT NULL THEN 0 WHEN RSHNB.BMNCD IS NOT NULL THEN 0 ELSE WK.C_BAI_100G END AS C_BAI_100G, WK.A_BAI_PACK, WK.B_BAI_PACK, WK.C_BAI_PACK, WK.A_BAI_1KG, WK.B_BAI_1KG, WK.C_BAI_1KG, WK.A_BAI_100GS, WK.B_BAI_100GS, WK.C_BAI_100GS, WK.AVGPTANKA, CASE WHEN RSHNA.BMNCD IS NOT NULL THEN RSHNA.IRISU WHEN RSHNB.BMNCD IS NOT NULL THEN RSHNB.IRISU WHEN RSHNC.BMNCD IS NOT NULL THEN RSHNC.IRISU ELSE WK.IRISU END AS IRISU, WK.TENSUU_BL1, WK.TENSUU_BL2, 0 AS A_BAI_1URI, WK.A_BAI_BL1, WK.A_BAI_BL2, 0 AS B_BAI_1URI, WK.B_BAI_BL1, WK.B_BAI_BL2, 0 AS C_BAI_1URI, WK.C_BAI_BL1, WK.C_BAI_BL2, WK.SIRECD, WK.NENMATSU, WK.TEIKBN, WK.TRTEISEK, WK.TTKBN, WK.KZKBN, WK.FUTEIKBN, WK.BETUDEN_KBN, WK.WAPPEN, WK.IKKATK, WK.JIZNUT, WK.SIDENF, WK.TEICUTK, WK.HOUZAI, WK.DSEIK, WK.PCKBN, WK.HIGAWARI_KBN, WK.HGENBAIKA_FLG, 2 AS REI_DMY_FLG, WK.UPDKBN, WK.SEISUR, WK.HENSUR, WK.SEITK, WK.NONSJ, WK.ATARA, WK.RDHMHYO, WK.RDHMMON, WK.RDHMTUE, WK.RDHMWED, WK.RDHMTHU, WK.RDHMFRI, WK.RDHMSAT, WK.RDHMSUN, WK.NONSU, WK.BUMNCD, WK.DAIBUNCD, WK.CHUBUNCD, WK.SHOBUNCD, WK.SSBUNCD, WK.MSSIRE, WK.MSIR, WK.MSIKK, WK.MSWAP, WK.MSBIN, WK.EVENT_KBN, WK.EVENT_SDATE, WK.EVENT_SEQ, WK.BUMN, WK.KANRI_NO, WK.EVENT_EDANO, WK.WEEK_NO, WK.SMISECD, WK.KZCUT, WK.KOUCUT, WK.TEICUT, WK.TOKCUT, WK.KYUCUT, WK.HACCUT, WK.NONCUT, WK.HSSCUT, WK.ZEROCUT, WK.FILLER_02, WK.SYORIK, WK.TOK_COMMENT, CASE WHEN RSHNA.BMNCD IS NOT NULL THEN RSHNA.KIKKN WHEN RSHNB.BMNCD IS NOT NULL THEN RSHNB.KIKKN WHEN RSHNC.BMNCD IS NOT NULL THEN RSHNC.KIKKN ELSE WK.KIKAKU END AS KIKAKU, WK.SANCHI, WK.JIZEN_DATE, WK.JH_LIST_DATE, WK.JH_TORI_DATE, WK.WEEK_HDATE, WK.TAISYO_TEN_RANK, WK.TEN_HSUU_TBL, WK.FILLER_03, WK.SAKUSEI, WK.DATA_KBN FROM (SELECT WK14.*, CASE WHEN WK14.HAN_SDATE = 0 THEN SHN.HBSTDT ELSE WK14.HAN_SDATE END AS HAN_SDATE2, CASE WHEN WK14.HAN_EDATE = 0 THEN SHN.HBEDDT ELSE WK14.HAN_EDATE END AS HAN_EDATE2 FROM INAWK.ANWK14_TN06_A WK14 LEFT OUTER JOIN INATK2.TOKTG_SHN SHN ON WK14.EVENT_KBN = SHN.MOYSKBN AND WK14.EVENT_SDATE = SHN.MOYSSTDT AND WK14.EVENT_SEQ = SHN.MOYSRBAN AND WK14.BUMN = SHN.BMNCD AND WK14.KANRI_NO = SHN.KANRINO AND WK14.EVENT_EDANO = SHN.KANRIENO WHERE WK14.REI_DMY_FLG = 1) WK LEFT OUTER JOIN A11TC34 RSHNA ON WK.BUMN = RSHNA.BMNCD AND WK.A_BAI_1URI = RSHNA.WRITUKBN AND WK.SHOHINCD = RSHNA.DUMMYCD AND (WK.HAN_SDATE2 BETWEEN RSHNA.HBSTDT AND RSHNA.HBEDDT OR WK.HAN_EDATE2 BETWEEN RSHNA.HBSTDT AND RSHNA.HBEDDT OR CASE WHEN WK.NOU_DATE < RSHNA.HBSTDT THEN WK.NOU_DATE ELSE - 1 END BETWEEN RSHNA.HBSTDT_BF AND RSHNA.HBEDDT_BF) AND CASE WHEN WK.NOU_DATE < RSHNA.HBSTDT THEN WK.NOU_DATE ELSE RSHNA.HBSTDT_BF END BETWEEN RSHNA.HBSTDT_BF AND RSHNA.HBEDDT_BF LEFT OUTER JOIN A11TC34 RSHNB ON WK.BUMN = RSHNB.BMNCD AND WK.B_BAI_1URI = RSHNB.WRITUKBN AND WK.SHOHINCD = RSHNB.DUMMYCD AND RSHNA.SHNCD = RSHNB.SHNCD AND (WK.HAN_SDATE2 BETWEEN RSHNB.HBSTDT AND RSHNB.HBEDDT OR WK.HAN_EDATE2 BETWEEN RSHNB.HBSTDT AND RSHNB.HBEDDT OR CASE WHEN WK.NOU_DATE < RSHNB.HBSTDT THEN WK.NOU_DATE ELSE - 1 END BETWEEN RSHNB.HBSTDT_BF AND RSHNB.HBEDDT_BF) AND CASE WHEN WK.NOU_DATE < RSHNB.HBSTDT THEN WK.NOU_DATE ELSE RSHNB.HBSTDT_BF END BETWEEN RSHNB.HBSTDT_BF AND RSHNB.HBEDDT_BF LEFT OUTER JOIN A11TC34 RSHNC ON WK.BUMN = RSHNC.BMNCD AND WK.C_BAI_1URI = RSHNC.WRITUKBN AND WK.SHOHINCD = RSHNC.DUMMYCD AND RSHNA.SHNCD = RSHNC.SHNCD AND (WK.HAN_SDATE2 BETWEEN RSHNC.HBSTDT AND RSHNC.HBEDDT OR WK.HAN_EDATE2 BETWEEN RSHNC.HBSTDT AND RSHNC.HBEDDT OR CASE WHEN WK.NOU_DATE < RSHNC.HBSTDT THEN WK.NOU_DATE ELSE - 1 END BETWEEN RSHNC.HBSTDT_BF AND RSHNC.HBEDDT_BF) AND CASE WHEN WK.NOU_DATE < RSHNC.HBSTDT THEN WK.NOU_DATE ELSE RSHNC.HBSTDT_BF END BETWEEN RSHNC.HBSTDT_BF AND RSHNC.HBEDDT_BF) WK WHERE RNO = 1;commit;" >>%OUTFILE% 2>&1
IF NOT %ERRORLEVEL%==0 GOTO ERROR
"%MYSQLPATH%mysql" %OPTION% -h %HOST% %DB_NAME% -u %USER_ID% --show-warnings -vv -e "ANALYZE TABLE INAWK.ANWK14_TN06R_A;commit;" >>%OUTFILE% 2>&1
IF NOT %ERRORLEVEL%==0 GOTO ERROR



:FINAL
EXIT /B 0

:ERROR
EXIT /B 1
