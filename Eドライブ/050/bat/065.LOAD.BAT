REM [026][069_LOAD]
@ECHO OFF

REM ログフォルダ作成
IF NOT EXIST %~DP0..\logs MKDIR %~DP0..\logs

REM コマンドフォルダ作成
IF NOT EXIST %~DP0..\cmd MKDIR %~DP0..\cmd

REM ログファイルの情報
SET OUTFILE=%~DP0../logs/setup.log
SET OUTTIME=%~DP0../logs/time.log

REM ベースフォルダ
SET BASEDIR=%~DP0..

REM 更新対象の情報
SET INFOSCRIPT=%~DP0..\cmd\%~N0.DB2


SET INFILENAME=
SET MSG=%DATE% %TIME% 催し検索_店舗 INATK.TOKMM_TEN LOAD処理
ECHO %MSG%
>> %OUTFILE% ECHO %MSG%
"%MYSQLPATH%mysql" %OPTION% -h %HOST% %DB_NAME% -u %USER_ID% --show-warnings -vv -e "TRUNCATE TABLE INATK.TOKMM_TEN; INSERT IGNORE INTO INATK.TOKMM_TEN (SELECT D1.MOYSKBN, D1.MOYSSTDT, D1.MOYSRBAN, 0 AS BMFG, 0 AS BMNO, D1.BMNCD, D1.KANRINO, D1.TENCD, 'BATCH' AS OP, CURRENT_TIMESTAMP AS ADT, CURRENT_TIMESTAMP AS UDT FROM (SELECT DISTINCT MOYSCD, MOYSKBN, MOYSSTDT, MOYSRBAN, BMNCD, KANRINO, TENCD FROM INAIF.AN_HANBAI_AFT WHERE UPDKBN = 0 AND ((GTSIMECHGKBN = 1 AND GTSIMEOKFLG = 1) OR (GTSIMECHGKBN = 2 AND GTSIMEOKFLG = 1) OR (GTSIMECHGKBN = 3 AND GTSIMEOKFLG = 0) OR (GTSIMECHGKBN = 4 AND GTSIMEOKFLG = 1) OR (GTSIMECHGKBN = 0 AND GTSIMEOKFLG = 0)) UNION SELECT DISTINCT MOYSCD, MOYSKBN, MOYSSTDT, MOYSRBAN, BMNCD, KANRINO, TENCD FROM INAIF.AN_NOUNYU_AFT WHERE UPDKBN IN (0, 8) AND ((GTSIMECHGKBN = 1 AND GTSIMEOKFLG = 1) OR (GTSIMECHGKBN = 2 AND GTSIMEOKFLG = 1) OR (GTSIMECHGKBN = 3 AND GTSIMEOKFLG = 0) OR (GTSIMECHGKBN = 4 AND GTSIMEOKFLG = 1) OR (GTSIMECHGKBN = 0 AND GTSIMEOKFLG = 0))) D1 INNER JOIN INATK.TOKTG_SHN D2 ON (D1.MOYSKBN = D2.MOYSKBN AND D1.MOYSSTDT = D2.MOYSSTDT AND D1.MOYSRBAN = D2.MOYSRBAN AND D1.BMNCD = D2.BMNCD AND D1.KANRINO = D2.KANRINO) UNION ALL SELECT D1.MOYSKBN, D1.MOYSSTDT, D1.MOYSRBAN, 0 AS BMFG, 0 AS BMNO, D1.BMNCD, D1.KANRINO, D1.TENCD, 'BATCH' AS OP, CURRENT_TIMESTAMP AS ADT, CURRENT_TIMESTAMP AS UDT FROM (SELECT MOYSCD, MOYSKBN, MOYSSTDT, MOYSRBAN, BMNCD, KANRINO, TENCD FROM INAIF.AN_HANBAI_NEQ WHERE UPDKBN = 0 AND ((GTSIMECHGKBN = 1 AND GTSIMEOKFLG = 1) OR (GTSIMECHGKBN = 2 AND GTSIMEOKFLG = 1) OR (GTSIMECHGKBN = 3 AND GTSIMEOKFLG = 0) OR (GTSIMECHGKBN = 4 AND GTSIMEOKFLG = 1) OR (GTSIMECHGKBN = 0 AND GTSIMEOKFLG = 0)) UNION SELECT MOYSCD, MOYSKBN, MOYSSTDT, MOYSRBAN, BMNCD, KANRINO, TENCD FROM INAIF.AN_NOUNYU_NEQ WHERE UPDKBN IN (0, 8) AND ((GTSIMECHGKBN = 1 AND GTSIMEOKFLG = 1) OR (GTSIMECHGKBN = 2 AND GTSIMEOKFLG = 1) OR (GTSIMECHGKBN = 3 AND GTSIMEOKFLG = 0) OR (GTSIMECHGKBN = 4 AND GTSIMEOKFLG = 1) OR (GTSIMECHGKBN = 0 AND GTSIMEOKFLG = 0))) D1 INNER JOIN INATK.TOKSP_SHN D2 ON (D1.MOYSKBN = D2.MOYSKBN AND D1.MOYSSTDT = D2.MOYSSTDT AND D1.MOYSRBAN = D2.MOYSRBAN AND D1.BMNCD = D2.BMNCD AND D1.KANRINO = D2.KANRINO) UNION ALL SELECT DISTINCT D1.MOYSKBN, D1.MOYSSTDT, D1.MOYSRBAN, 1 AS BMFG, D1.BMNCD AS BMNO, D1.BMNO AS BMNCD, D1.KANRINO, D1.TENCD, 'BATCH' AS OP, CURRENT_TIMESTAMP AS ADT, CURRENT_TIMESTAMP AS UDT FROM INAIF.MS_HANBAI_BMS D1 INNER JOIN INATK.TOKMOYCD D2 ON D1.MOYSKBN = D2.MOYSKBN AND D1.MOYSSTDT = D2.MOYSSTDT AND D1.MOYSRBAN = D2.MOYSRBAN WHERE D1.UPDKBN = 0 UNION ALL SELECT DISTINCT D1.MOYSKBN, D1.MOYSSTDT, D1.MOYSRBAN, 0 AS BMFG, 0 AS BMNO, D1.BMNCD, D1.KANRINO, NUMS.TENCD, 'BATCH' AS OP, CURRENT_TIMESTAMP AS ADT, CURRENT_TIMESTAMP AS UDT FROM INATK.TOKSO_SHN D1 INNER JOIN INATK.TOKMOYCD D2 ON D1.MOYSKBN = D2.MOYSKBN AND D1.MOYSSTDT = D2.MOYSSTDT AND D1.MOYSRBAN = D2.MOYSRBAN LEFT OUTER JOIN (SELECT NUMS.SEQ AS TENCD FROM INAPARM.MSTNUMS NUMS WHERE NUMS.SEQ BETWEEN 1 AND 400) NUMS ON 1 = 1 WHERE D1.UPDKBN = 0 AND TRIM(SUBSTR(D1.TENATSUK_ARR, NUMS.TENCD, 1)) <> '' UNION ALL SELECT DISTINCT D1.MOYSKBN, D1.MOYSSTDT, D1.MOYSRBAN, 0 AS BMFG, 0 AS BMNO, CAST('0' || SUBSTR(D1.SHNCD, 1, 2) AS SIGNED) AS BMNCD, D1.KANRINO, NUMS.TENCD, 'BATCH' AS OP, CURRENT_TIMESTAMP AS ADT, CURRENT_TIMESTAMP AS UDT FROM INATK.TOKJU_SHN D1 INNER JOIN INATK.TOKMOYCD D2 ON D1.MOYSKBN = D2.MOYSKBN AND D1.MOYSSTDT = D2.MOYSSTDT AND D1.MOYSRBAN = D2.MOYSRBAN LEFT OUTER JOIN (SELECT NUMS.SEQ AS TENCD FROM INAPARM.MSTNUMS NUMS WHERE NUMS.SEQ BETWEEN 1 AND 400) NUMS ON 1 = 1 WHERE D1.UPDKBN = 0 AND TRIM(SUBSTR(D1.TENHTSU_ARR, (NUMS.TENCD - 1) * 5 + 1, 5)) <> '' UNION ALL SELECT DISTINCT D1.MOYSKBN, D1.MOYSSTDT, D1.MOYSRBAN, 0 AS BMFG, 0 AS BMNO, CAST('0' || SUBSTR(D1.SHNCD, 1, 2) AS SIGNED) AS BMNCD, D1.KANRINO, NUMS.TENCD, 'BATCH' AS OP, CURRENT_TIMESTAMP AS ADT, CURRENT_TIMESTAMP AS UDT FROM INATK.TOKQJU_SHN D1 INNER JOIN INATK.TOKMOYCD D2 ON D1.MOYSKBN = D2.MOYSKBN AND D1.MOYSSTDT = D2.MOYSSTDT AND D1.MOYSRBAN = D2.MOYSRBAN LEFT OUTER JOIN (SELECT NUMS.SEQ AS TENCD FROM INAPARM.MSTNUMS NUMS WHERE NUMS.SEQ BETWEEN 1 AND 400) NUMS ON 1 = 1 WHERE D1.UPDKBN = 0 AND TRIM(SUBSTR(D1.TENHTSU_ARR, (NUMS.TENCD - 1) * 5 + 1, 5)) <> '');commit;" >>%OUTFILE% 2>&1
IF NOT %ERRORLEVEL%==0 GOTO ERROR

"%MYSQLPATH%mysql" %OPTION% -h %HOST% %DB_NAME% -u %USER_ID% --show-warnings -vv -e "ANALYZE TABLE INATK.TOKMM_TEN;" >>%OUTFILE% 2>&1
IF ERRORLEVEL 1 GOTO ERROR

SET OUTFILENAME=%~DP0..\data\INATK.TOKMM_TEN
"%MYSQLPATH%mysql" %OPTION% -h %HOST% %DB_NAME% -u %USER_ID% -N -e "SELECT * FROM INATK.TOKMM_TEN;" >%OUTFILENAME% 2>>%OUTFILE%
IF ERRORLEVEL 1 GOTO ERROR


:FINAL
EXIT /B 0

:ERROR
EXIT /B 1
