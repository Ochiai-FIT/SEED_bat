REM [026][069_LOAD]
@ECHO OFF

REM ログフォルダ作成
IF NOT EXIST %~DP0..\logs MKDIR %~DP0..\logs

REM コマンドフォルダ作成
IF NOT EXIST %~DP0..\cmd MKDIR %~DP0..\cmd

REM ログファイルの情報
SET OUTFILE=%~DP0../logs/setup.log
SET OUTTIME=%~DP0../logs/time.log

REM ベースフォルダ
SET BASEDIR=%~DP0..

REM 更新対象の情報
SET INFOSCRIPT=%~DP0..\cmd\%~N0.DB2


SET INFILENAME=
SET MSG=%DATE% %TIME% FTPログ INAAD.SYSFTPLOG BACKUP処理
ECHO %MSG%
>> %OUTFILE% ECHO %MSG%
SET OUTFILENAME=%~DP0..\DATA\INAAD.SYSFTPLOG
"%MYSQLPATH%mysql" %OPTION% -h %HOST% %DB_NAME% -u %USER_ID% -N -e "SELECT COALESCE(SEQ, '') || ',' || COALESCE(STARTDT, '') || ',' || COALESCE(ENDDT, '') || ',' || COALESCE(SENDADDR, '') || ',' || COALESCE(RECVADDR, '') || ',' || COALESCE(FILENM, '') || ',' || COALESCE(DTSYU, '') || ',' || COALESCE(STATUS, '') || ',' || COALESCE(ERRCD, '') || ',' || COALESCE(COMMENTS, '') || ',' || COALESCE(OPERATOR, '') || ',' || COALESCE(ADDDT, '') FROM INAAD.SYSFTPLOG;" >%OUTFILENAME% 2>>%OUTFILE%
IF NOT %ERRORLEVEL%==0 GOTO ERROR

SET MSG=%DATE% %TIME% FTPログ INAAD.SYSFTPLOG DELETE処理
ECHO %MSG%
>> %OUTFILE% ECHO %MSG%
"%MYSQLPATH%mysql" %OPTION% -h %HOST% %DB_NAME% -u %USER_ID% --show-warnings -vv -e"DELETE FROM INAAD.SYSFTPLOG WHERE ADDDT < CURRENT_TIMESTAMP - INTERVAL 1 YEAR;commit;" >>%OUTFILE% 2>&1
IF %ERRORLEVEL% GTR 1 GOTO ERROR


SET MSG=%DATE% %TIME% アプリケーションログ管理 INAAD.TBLAPLOG BACKUP処理
ECHO %MSG%
>> %OUTFILE% ECHO %MSG%
SET OUTFILENAME=%~DP0..\DATA\INAAD.TBLAPLOG
"%MYSQLPATH%mysql" %OPTION% -h %HOST% %DB_NAME% -u %USER_ID% -N -e "SELECT COALESCE(CPUNAM, '') || ',' || COALESCE(IPADDR, '') || ',' || COALESCE(LOGTIME, '') || ',' || COALESCE(LOGKBN, '') || ',' || COALESCE(LOGINID, '') || ',' || COALESCE(FORMID, '') || ',' || COALESCE(ERRNO, '') || ',' || COALESCE(ORAERRN, '') || ',' || COALESCE(LOGTXT1, '') || ',' || COALESCE(LOGTXT2, '') || ',' || COALESCE(LOGTXT3, '') FROM INAAD.TBLAPLOG;" >%OUTFILENAME% 2>>%OUTFILE%
IF NOT %ERRORLEVEL%==0 GOTO ERROR

SET MSG=%DATE% %TIME% アプリケーションログ管理 INAAD.TBLAPLOG DELETE処理
ECHO %MSG%
>> %OUTFILE% ECHO %MSG%
"%MYSQLPATH%mysql" %OPTION% -h %HOST% %DB_NAME% -u %USER_ID% --show-warnings -vv -e "DELETE FROM INAAD.TBLAPLOG WHERE LOGTIME < CURRENT_TIMESTAMP - INTERVAL 1 YEAR;commit;" >>%OUTFILE% 2>&1
IF NOT %ERRORLEVEL%==0 GOTO ERROR

SET MSG=%DATE% %TIME% 通信ログ記録用 INAAD.TBLTSNKNR BACKUP処理
ECHO %MSG%
>> %OUTFILE% ECHO %MSG%
SET OUTFILENAME=%~DP0..\DATA\INAAD.TBLTSNKNR
"%MYSQLPATH%mysql" %OPTION% -h %HOST% %DB_NAME% -u %USER_ID% -N -e "SELECT COALESCE(TSNBAN, '') || ',' || COALESCE(DATSYU, '') || ',' || COALESCE(TRNKBN, '') || ',' || COALESCE(SHRHMS, '') || ',' || COALESCE(TRNCNT, '') || ',' || COALESCE(TRNSTS, '') || ',' || COALESCE(ERRNYO, '') || ',' || COALESCE(UPDNO, '') || ',' || COALESCE(UPDYMD, '') FROM INAAD.TBLTSNKNR;" >%OUTFILENAME% 2>>%OUTFILE%
IF NOT %ERRORLEVEL%==0 GOTO ERROR

SET MSG=%DATE% %TIME% 通信ログ記録用 INAAD.TBLTSNKNR DELETE処理
ECHO %MSG%
>> %OUTFILE% ECHO %MSG%
"%MYSQLPATH%mysql" %OPTION% -h %HOST% %DB_NAME% -u %USER_ID% --show-warnings -vv -e "DELETE FROM INAAD.TBLTSNKNR WHERE UPDYMD < CURRENT_TIMESTAMP - INTERVAL 1 YEAR;commit;" >>%OUTFILE% 2>&1
IF NOT %ERRORLEVEL%==0 GOTO ERROR





:FINAL
EXIT /B 0

:ERROR
EXIT /B 1
