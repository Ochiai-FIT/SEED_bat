REM [026][069_LOAD]
@ECHO OFF

REM ログフォルダ作成
IF NOT EXIST %~DP0..\logs MKDIR %~DP0..\logs

REM コマンドフォルダ作成
IF NOT EXIST %~DP0..\cmd MKDIR %~DP0..\cmd

REM ログファイルの情報
SET OUTFILE=%~DP0../logs/setup.log
SET OUTTIME=%~DP0../logs/time.log

REM ベースフォルダ
SET BASEDIR=%~DP0..

REM 更新対象の情報
SET INFOSCRIPT=%~DP0..\cmd\%~N0.DB2


SET INFILENAME=
REM バックアップ
SET MSG=%DATE% %TIME% 新店改装店発注 INATK.HATSK BACKUP処理
ECHO %MSG%
>> %OUTFILE% ECHO %MSG%
SET OUTFILENAME=%~DP0..\DATA\INATK.HATSK
"%MYSQLPATH%mysql" %OPTION% -h %HOST% %DB_NAME% -u %USER_ID% -N -e "SELECT COALESCE(INPUTNO, '') || ',' || COALESCE(TENNO, '') || ',' || COALESCE(HTDT, '') || ',' || COALESCE(NNDT, '') || ',' || COALESCE(SHNKBN, '') || ',' || COALESCE(KSPAGE, '') || ',' || COALESCE(BDENKBN, '') || ',' || COALESCE(UPDKBN, '') || ',' || COALESCE(SENDFLG, '') || ',' || COALESCE(OPERATOR, '') || ',' || COALESCE(ADDDT, '') || ',' || COALESCE(UPDDT, '') FROM INATK.HATSK;" >%OUTFILENAME% 2>>%OUTFILE%
IF NOT %ERRORLEVEL%==0 GOTO ERROR

SET MSG=%DATE% %TIME% 新店改装店発注_商品 INATK.HATSK_SHN BACKUP処理
ECHO %MSG%
>> %OUTFILE% ECHO %MSG%
SET OUTFILENAME=%~DP0..\DATA\INATK.HATSK_SHN
"%MYSQLPATH%mysql" %OPTION% -h %HOST% %DB_NAME% -u %USER_ID% -N -e "SELECT COALESCE(INPUTNO, '') || ',' || COALESCE(KANRINO, '') || ',' || COALESCE(SHNCD, '') || ',' || COALESCE(SURYO, '') || ',' || COALESCE(SENDFLG, '') || ',' || COALESCE(OPERATOR, '') || ',' || COALESCE(ADDDT, '') || ',' || COALESCE(UPDDT, '') FROM INATK.HATSK_SHN;" >%OUTFILENAME% 2>>%OUTFILE%
IF NOT %ERRORLEVEL%==0 GOTO ERROR

SET MSG=%DATE% %TIME% 新店改装店発注_内部管理 INATK.SYSSK BACKUP処理
ECHO %MSG%
>> %OUTFILE% ECHO %MSG%
SET OUTFILENAME=%~DP0..\DATA\INATK.SYSSK
"%MYSQLPATH%mysql" %OPTION% -h %HOST% %DB_NAME% -u %USER_ID% -N -e "SELECT COALESCE(INPUTNO, '') || ',' || COALESCE(SUMI_KANRINO, '') || ',' || COALESCE(OPERATOR, '') || ',' || COALESCE(ADDDT, '') || ',' || COALESCE(UPDDT, '') FROM INATK.SYSSK;" >%OUTFILENAME% 2>>%OUTFILE%
IF NOT %ERRORLEVEL%==0 GOTO ERROR


REM 削除
SET MSG=%DATE% %TIME% 新店改装店発注 INATK.HATSK DELETE処理
ECHO %MSG%
>> %OUTFILE% ECHO %MSG%
"%MYSQLPATH%mysql" %OPTION% -h %HOST% %DB_NAME% -u %USER_ID% --show-warnings -vv -e "DELETE FROM INATK.HATSK T1 WHERE EXISTS (SELECT 1 FROM (SELECT CAST(DATE_FORMAT(DATE_FORMAT(SHORIDT, '%%Y%%m%%d') - INTERVAL 2 DAY - INTERVAL X.MWDSU DAY, '%%Y%%m%%d') AS SIGNED) AS SHORIDT FROM INAAD.SYSSHORIDT, (SELECT MWDSU FROM INAAD.SYSTOKDELCTL WHERE P_TABLENM = 'HATSK' AND PTNCD = '1') X) T2 WHERE T1.HTDT <= T2.SHORIDT AND T1.SENDFLG=1);commit;" >>%OUTFILE% 2>&1
IF %ERRORLEVEL% GTR 1 GOTO ERROR

SET MSG=%DATE% %TIME% 新店改装店発注_商品 INATK.HATSK_SHN DELETE処理
ECHO %MSG%
>> %OUTFILE% ECHO %MSG%
"%MYSQLPATH%mysql" %OPTION% -h %HOST% %DB_NAME% -u %USER_ID% --show-warnings -vv -e "DELETE FROM INATK.HATSK_SHN T1 WHERE NOT EXISTS (SELECT 1 FROM INATK.HATSK T2 WHERE T2.INPUTNO=T1.INPUTNO AND T2.SENDFLG=1);commit;" >>%OUTFILE% 2>&1
IF %ERRORLEVEL% GTR 1 GOTO ERROR

SET MSG=%DATE% %TIME% 新店改装店発注_内部管理 INATK.SYSSK DELETE処理
ECHO %MSG%
>> %OUTFILE% ECHO %MSG%
"%MYSQLPATH%mysql" %OPTION% -h %HOST% %DB_NAME% -u %USER_ID% --show-warnings -vv -e "DELETE FROM INATK.SYSSK T1 WHERE NOT EXISTS (SELECT 1 FROM INATK.HATSK T2 WHERE T2.INPUTNO=T1.INPUTNO AND T2.SENDFLG=1);commit;" >>%OUTFILE% 2>&1
IF %ERRORLEVEL% GTR 1 GOTO ERROR



:FINAL
EXIT /B 0

:ERROR
EXIT /B 1
