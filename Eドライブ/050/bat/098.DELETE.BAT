REM [026][069_LOAD]
@ECHO OFF

REM ログフォルダ作成
IF NOT EXIST %~DP0..\logs MKDIR %~DP0..\logs

REM コマンドフォルダ作成
IF NOT EXIST %~DP0..\cmd MKDIR %~DP0..\cmd

REM ログファイルの情報
SET OUTFILE=%~DP0../logs/setup.log
SET OUTTIME=%~DP0../logs/time.log

REM ベースフォルダ
SET BASEDIR=%~DP0..

REM 更新対象の情報
SET INFOSCRIPT=%~DP0..\cmd\%~N0.DB2


SET INFILENAME=
SET MSG=%DATE% %TIME% 実績率パターン INATK.TOKJRTPTN BACKUP処理
ECHO %MSG%
>> %OUTFILE% ECHO %MSG%
SET OUTFILENAME=%~DP0..\DATA\INATK.TOKJRTPTN
"%MYSQLPATH%mysql" %OPTION% -h %HOST% %DB_NAME% -u %USER_ID% -N -e "SELECT COALESCE(BMNCD, '') || ',' || COALESCE(WWMMFLG, '') || ',' || COALESCE(YYMM, '') || ',' || COALESCE(DAICD, '') || ',' || COALESCE(CHUCD, '') || ',' || COALESCE(TENURI_ARR, '') || ',' || COALESCE(TENTEN_ARR, '') || ',' || COALESCE(OPERATOR, '') || ',' || COALESCE(ADDDT, '') || ',' || COALESCE(UPDDT, '') FROM INATK.TOKJRTPTN;" >%OUTFILENAME% 2>>%OUTFILE%
IF %ERRORLEVEL% GTR 1 GOTO ERROR

SET MSG=%DATE% %TIME% 実績率パターン（月次） INATK.TOKJRTPTN DELETE処理
ECHO %MSG%
>> %OUTFILE% ECHO %MSG%
"%MYSQLPATH%mysql" %OPTION% -h %HOST% %DB_NAME% -u %USER_ID% --show-warnings -vv -e"DELETE FROM INATK.TOKJRTPTN T1 WHERE EXISTS (SELECT 1 FROM (SELECT CASE WHEN DAY(DATE_FORMAT(SHORIDT, '%%Y%%m%%d')) = 1 THEN CAST(DATE_FORMAT(DATE_FORMAT(SHORIDT, '%%Y%%m%%d') - INTERVAL 1 DAY - INTERVAL X.MWDSU MONTH, '%%y%%m') AS SIGNED) ELSE 0 END AS SHORIDT FROM INAAD.SYSSHORIDT, (SELECT MWDSU FROM INAAD.SYSTOKDELCTL WHERE P_TABLENM = 'TOKJRTPTN' AND PTNCD = '2') X) T2 WHERE T1.YYMM <= T2.SHORIDT AND T1.WWMMFLG=2);commit;" >>%OUTFILE% 2>&1
IF %ERRORLEVEL% GTR 1 GOTO ERROR



SET MSG=%DATE% %TIME% 実績率パターン（週次） INATK.TOKJRTPTN DELETE処理
ECHO %MSG%
>> %OUTFILE% ECHO %MSG%
"%MYSQLPATH%mysql" %OPTION% -h %HOST% %DB_NAME% -u %USER_ID% --show-warnings -vv -e "DELETE FROM INATK.TOKJRTPTN T1 WHERE EXISTS (SELECT 1 FROM (SELECT MAX(T1.SHUNO) AS SHUNO FROM INAAD.SYSSHUNO T1 INNER JOIN (SELECT CASE WHEN DAYOFWEEK(DATE_FORMAT(SHORIDT, '%%Y%%m%%d') - INTERVAL 1 DAY) = 1 THEN CAST(DATE_FORMAT(DATE_FORMAT(SHORIDT, '%%Y%%m%%d') - INTERVAL (X.MWDSU * 7) DAY, '%%Y%%m%%d') AS SIGNED) ELSE 0 END AS SHORIDT FROM INAAD.SYSSHORIDT, (SELECT MWDSU FROM INAAD.SYSTOKDELCTL WHERE P_TABLENM = 'TOKJRTPTN' AND PTNCD = '1') X) T2 ON T1.ENDDT <= T2.SHORIDT) T2 WHERE T1.YYMM <= T2.SHUNO AND T1.WWMMFLG=1);commit;" >>%OUTFILE% 2>&1
IF %ERRORLEVEL% GTR 1 GOTO ERROR


:FINAL
EXIT /B 0

:ERROR
EXIT /B 1
