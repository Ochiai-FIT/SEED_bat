REM [026][069_LOAD]
@ECHO OFF

REM ログフォルダ作成
IF NOT EXIST %~DP0..\logs MKDIR %~DP0..\logs

REM コマンドフォルダ作成
IF NOT EXIST %~DP0..\cmd MKDIR %~DP0..\cmd

REM ログファイルの情報
SET OUTFILE=%~DP0../logs/setup.log
SET OUTTIME=%~DP0../logs/time.log

REM ベースフォルダ
SET BASEDIR=%~DP0..

REM 更新対象の情報
SET INFOSCRIPT=%~DP0..\cmd\%~N0.DB2


SET INFILENAME=
REM バックアップ
SET MSG=%DATE% %TIME% 予約発注_企画 INATK.HATYH_KKK BACKUP処理
SET OUTFILENAME=%~DP0..\DATA\INATK.HATYH_KKK
ECHO %OUTFILENAME% >> %OUTFILE%
ECHO %MSG%
>> %OUTFILE% ECHO %MSG%
SET OUTFILENAME=%~DP0..\DATA\INATK.HATYH_KKK
"%MYSQLPATH%mysql" %OPTION% -h %HOST% %DB_NAME% -u %USER_ID% -N -e "SELECT COALESCE(KKKCD, '') || ',' || COALESCE(KKKKM, '') || ',' || COALESCE(NNSTDT, '') || COALESCE(9, '') || COALESCE(NNEDDT, '') || ',' || COALESCE(UPDKBN, '') || ',' || COALESCE(SENDFLG, '') || ',' || COALESCE(OPERATOR, '') || ',' || COALESCE(ADDDT, '') || ',' || COALESCE(UPDDT, '') FROM INATK.HATYH_KKK;" >%OUTFILENAME% 2>>%OUTFILE%

SET MSG=%DATE% %TIME% 予約発注_商品 INATK.HATYH_SHN BACKUP処理
SET OUTFILENAME=%~DP0..\DATA\INATK.HATYH_SHN
ECHO %OUTFILENAME% >> %OUTFILE%
ECHO %MSG%
>> %OUTFILE% ECHO %MSG%
SET OUTFILENAME=%~DP0..\DATA\INATK.HATYH_SHN
"%MYSQLPATH%mysql" %OPTION% -h %HOST% %DB_NAME% -u %USER_ID% -N -e "SELECT COALESCE(KKKCD, '') || ',' || COALESCE(SHNCD, '') || ',' || COALESCE(CATALGNO, '') || ',' || COALESCE(HTDT, '') || ',' || COALESCE(UKESTDT, '') || ',' || COALESCE(UKEEDDT, '') || ',' || COALESCE(TENISTDT, '') || ',' || COALESCE(TENIEDDT, '') || ',' || COALESCE(YOTEISU, '') || ',' || COALESCE(GENDOSU, '') || ',' || COALESCE(NGFLG, '') || ',' || COALESCE(UPDKBN, '') || ',' || COALESCE(SENDFLG, '') || ',' || COALESCE(OPERATOR, '') || ',' || COALESCE(OPERATOR, '') || ',' || COALESCE(ADDDT, '') || ',' || COALESCE(UPDDT, '') FROM INATK.HATYH_SHN;" >%OUTFILENAME% 2>>%OUTFILE%

SET MSG=%DATE% %TIME% 予約発注_納入日 INATK.HATYH_NNDT BACKUP処理
SET OUTFILENAME=%~DP0..\DATA\INATK.HATYH_NNDT
ECHO %OUTFILENAME% >> %OUTFILE%
ECHO %MSG%
>> %OUTFILE% ECHO %MSG%
SET OUTFILENAME=%~DP0..\DATA\INATK.HATYH_NNDT
"%MYSQLPATH%mysql" %OPTION% -h %HOST% %DB_NAME% -u %USER_ID% -N -e "SELECT COALESCE(KKKCD, '') || ',' || COALESCE(SHNCD, '') || ',' || COALESCE(NNDT, '') || ',' || COALESCE(YOTEISU, '') || ',' || COALESCE(GENDOSU, '') || COALESCE(9, '') || COALESCE(SENDFLG, '') || ',' || COALESCE(OPERATOR, '') || ',' || COALESCE(ADDDT, '') || ',' || COALESCE(UPDDT, '') FROM INATK.HATYH_NNDT;" >%OUTFILENAME% 2>>%OUTFILE%

SET MSG=%DATE% %TIME% 予約発注_店舗 INATK.HATYH_TEN BACKUP処理
SET OUTFILENAME=%~DP0..\DATA\INATK.HATYH_TEN
ECHO %OUTFILENAME% >> %OUTFILE%
ECHO %MSG%
>> %OUTFILE% ECHO %MSG%
SET OUTFILENAME=%~DP0..\DATA\INATK.HATYH_TEN
"%MYSQLPATH%mysql" %OPTION% -h %HOST% %DB_NAME% -u %USER_ID% -N -e "SELECT COALESCE(KKKCD, '') || ',' || COALESCE(SHNCD, '') || ',' || COALESCE(NNDT, '') || ',' || COALESCE(INPUTDT, '') || ',' || COALESCE(TENCD, '') || ',' || COALESCE(HTSU, '') || ',' || COALESCE(SENDFLG, '') || ',' || COALESCE(OPERATOR, '') || ',' || COALESCE(ADDDT, '') || ',' || COALESCE(UPDDT, '') FROM INATK.HATYH_TEN;" >%OUTFILENAME% 2>>%OUTFILE%

REM 削除
SET MSG=%DATE% %TIME% 予約発注_企画 INATK.HATYH_KKK DELETE処理
ECHO %MSG%
>> %OUTFILE% ECHO %MSG%
"%MYSQLPATH%mysql" %OPTION% -h %HOST% %DB_NAME% -u %USER_ID% --show-warnings -vv -e "DELETE FROM INATK.HATYH_KKK T1 WHERE EXISTS (SELECT 1 FROM (SELECT CAST(DATE_FORMAT(DATE_FORMAT(SHORIDT, '%%Y%%m%%d') - INTERVAL 1 DAY - INTERVAL X.MWDSU DAY, '%%Y%%m%%d') AS SIGNED) AS SHORIDT FROM INAAD.SYSSHORIDT, (SELECT MWDSU FROM INAAD.SYSTOKDELCTL WHERE P_TABLENM = 'HATSK' AND PTNCD = '1') X) T2 WHERE T1.NNEDDT <= T2.SHORIDT AND T1.SENDFLG=1);commit;" >>%OUTFILE% 2>&1
IF %ERRORLEVEL% GTR 1 GOTO ERROR

SET MSG=%DATE% %TIME% 予約発注_商品 INATK.HATYH_SHN DELETE処理
ECHO %MSG%
>> %OUTFILE% ECHO %MSG%
"%MYSQLPATH%mysql" %OPTION% -h %HOST% %DB_NAME% -u %USER_ID% --show-warnings -vv -e "DELETE FROM INATK.HATYH_SHN T1 WHERE NOT EXISTS (SELECT 1 FROM INATK.HATYH_KKK T2 WHERE T2.KKKCD=T1.KKKCD AND T2.SENDFLG=1);commit;" >>%OUTFILE% 2>&1
IF %ERRORLEVEL% GTR 1 GOTO ERROR

SET MSG=%DATE% %TIME% 予約発注_納入日 INATK.HATYH_NNDT DELETE処理
ECHO %MSG%
>> %OUTFILE% ECHO %MSG%
"%MYSQLPATH%mysql" %OPTION% -h %HOST% %DB_NAME% -u %USER_ID% --show-warnings -vv -e "DELETE FROM INATK.HATYH_NNDT T1 WHERE NOT EXISTS (SELECT 1 FROM INATK.HATYH_KKK T2 WHERE T2.KKKCD=T1.KKKCD AND T2.SENDFLG=1);commit;" >>%OUTFILE% 2>&1
IF %ERRORLEVEL% GTR 1 GOTO ERROR

SET MSG=%DATE% %TIME% 予約発注_店舗 INATK.HATYH_TEN DELETE処理
ECHO %MSG%
>> %OUTFILE% ECHO %MSG%
"%MYSQLPATH%mysql" %OPTION% -h %HOST% %DB_NAME% -u %USER_ID% --show-warnings -vv -e "DELETE FROM INATK.HATYH_TEN T1 WHERE NOT EXISTS (SELECT 1 FROM INATK.HATYH_KKK T2 WHERE T2.KKKCD=T1.KKKCD AND T2.SENDFLG=1);commit;" >>%OUTFILE% 2>&1
IF %ERRORLEVEL% GTR 1 GOTO ERROR

:FINAL
EXIT /B 0

:ERROR
EXIT /B 1
