REM [026][069_LOAD]
@ECHO OFF

REM ログフォルダ作成
IF NOT EXIST %~DP0..\logs MKDIR %~DP0..\logs

REM コマンドフォルダ作成
IF NOT EXIST %~DP0..\cmd MKDIR %~DP0..\cmd

REM ログファイルの情報
SET OUTFILE=%~DP0../logs/setup.log
SET OUTTIME=%~DP0../logs/time.log

REM ベースフォルダ
SET BASEDIR=%~DP0..

REM 更新対象の情報
SET INFOSCRIPT=%~DP0..\cmd\%~N0.DB2


SET INFILENAME=
SET MSG=%DATE% %TIME% CSV取込トラン_特売ヘッダ INATK.CSVTOKHEAD BACKUP処理
ECHO %MSG%
>> %OUTFILE% ECHO %MSG%
SET OUTFILENAME=%~DP0..\DATA\INATK.CSVTOKHEAD
"%MYSQLPATH%mysql" %OPTION% -h %HOST% %DB_NAME% -u %USER_ID% -N -e "SELECT COALESCE(SEQ, '') || ',' || COALESCE(DATAKIND, '') || ',' || COALESCE(OPERATOR, '') || ',' || COALESCE(INPUT_DATE, '') || ',' || COALESCE(COMMENTKN, '') FROM INATK.CSVTOKHEAD;" >%OUTFILENAME% 2>>%OUTFILE%
IF NOT %ERRORLEVEL%==0 GOTO ERROR

SET MSG=%DATE% %TIME% CSV取込トラン_特売ヘッダ INATK.CSVTOKHEAD DELETE処理
ECHO %MSG%
>> %OUTFILE% ECHO %MSG%
"%MYSQLPATH%mysql" %OPTION% -h %HOST% %DB_NAME% -u %USER_ID% --show-warnings -vv -e "DELETE FROM INATK.CSVTOKHEAD T1 WHERE EXISTS (SELECT 1 FROM (SELECT DATE_FORMAT(SHORIDT, '%%Y%%m%%d') - INTERVAL 1 DAY - INTERVAL X.MWDSU DAY AS SHORIDT FROM INAAD.SYSSHORIDT, (SELECT MWDSU FROM INAAD.SYSTOKDELCTL WHERE P_TABLENM = 'CSVTOKHEAD' AND PTNCD = '1') X) T2 WHERE T1.INPUT_DATE <= T2.SHORIDT);commit;" >>%OUTFILE% 2>&1
IF NOT %ERRORLEVEL%==0 GOTO ERROR


SET MSG=%DATE% %TIME% CSV取込トラン_生活応援 INATK.CSVTOK_SO BACKUP処理
ECHO %MSG%
>> %OUTFILE% ECHO %MSG%
SET OUTFILENAME=%~DP0..\DATA\INATK.CSVTOK_SO
"%MYSQLPATH%mysql" %OPTION% -h %HOST% %DB_NAME% -u %USER_ID% -N -e "SELECT COALESCE(SEQ, '') || ',' || COALESCE(INPUTNO, '') || ',' || COALESCE(ERRCD, '') || ',' || COALESCE(ERRFLD, '') || ',' || COALESCE(ERRVL, '') || ',' || COALESCE(ERRTBLNM, '') || ',' || COALESCE(CSV_UPDKBN, '') || ',' || COALESCE(MOYSKBN, '') || ',' || COALESCE(MOYSSTDT, '') || ',' || COALESCE(MOYSRBAN, '') || ',' || COALESCE(SHNCD, '') || ',' || COALESCE(BMNCD, '') || ',' || COALESCE(MAKERKN, '') || ',' || COALESCE(SHNKN, '') || ',' || COALESCE(KIKKN, '') || ',' || COALESCE(IRISU, '') || ',' || COALESCE(MINSU, '') || ',' || COALESCE(GENKAAM, '') || ',' || COALESCE(A_BAIKAAM, '') || ',' || COALESCE(B_BAIKAAM, '') || ',' || COALESCE(C_BAIKAAM, '') || ',' || COALESCE(A_RANKNO, '') || ',' || COALESCE(B_RANKNO, '') || ',' || COALESCE(C_RANKNO, '') || ',' || COALESCE(POPCD, '') || ',' || COALESCE(POPSZ, '') || ',' || COALESCE(POPSU, '') || ',' || COALESCE(TENATSUK_ARR, '') || ',' || COALESCE(UPDKBN, '') || ',' || COALESCE(OPERATOR, '') || ',' || COALESCE(ADDDT, '') || ',' || COALESCE(UPDDT, '') FROM INATK.CSVTOK_SO;" >%OUTFILENAME% 2>>%OUTFILE%
IF NOT %ERRORLEVEL%==0 GOTO ERROR

SET MSG=%DATE% %TIME% CSV取込トラン_生活応援 INATK.CSVTOK_SO DELETE処理
ECHO %MSG%
>> %OUTFILE% ECHO %MSG%
"%MYSQLPATH%mysql" %OPTION% -h %HOST% %DB_NAME% -u %USER_ID% --show-warnings -vv -e "DELETE FROM INATK.CSVTOK_SO T1 WHERE NOT EXISTS (SELECT 1 FROM INATK.CSVTOKHEAD T2 WHERE T2.SEQ=T1.SEQ);commit;" >>%OUTFILE% 2>&1
IF NOT %ERRORLEVEL%==0 GOTO ERROR


SET MSG=%DATE% %TIME% CSV取込トラン_冷凍食品_企画 INATK.CSVTOK_RSKKK BACKUP処理
ECHO %MSG%
>> %OUTFILE% ECHO %MSG%
SET OUTFILENAME=%~DP0..\DATA\INATK.CSVTOK_RSKKK
"%MYSQLPATH%mysql" %OPTION% -h %HOST% %DB_NAME% -u %USER_ID% -N -e "SELECT COALESCE(SEQ, '') || ',' || COALESCE(INPUTNO, '') || ',' || COALESCE(HBSTDT, '') || ',' || COALESCE(BMNCD, '') || ',' || COALESCE(WRITUKBN, '') || ',' || COALESCE(SEICUTKBN, '') || ',' || COALESCE(DUMMYCD, '') || ',' || COALESCE(MEISHOKN, '') || ',' || COALESCE(UPDKBN, '') || ',' || COALESCE(OPERATOR, '') || ',' || COALESCE(ADDDT, '') || ',' || COALESCE(UPDDT, '') FROM INATK.CSVTOK_RSKKK;" >%OUTFILENAME% 2>>%OUTFILE%
IF NOT %ERRORLEVEL%==0 GOTO ERROR

SET MSG=%DATE% %TIME% CSV取込トラン_冷凍食品_企画 INATK.CSVTOK_RSKKK DELETE処理
ECHO %MSG%
>> %OUTFILE% ECHO %MSG%
"%MYSQLPATH%mysql" %OPTION% -h %HOST% %DB_NAME% -u %USER_ID% --show-warnings -vv -e "DELETE FROM INATK.CSVTOK_RSKKK T1 WHERE NOT EXISTS (SELECT 1 FROM INATK.CSVTOKHEAD T2 WHERE T2.SEQ=T1.SEQ);commit;" >>%OUTFILE% 2>&1
IF NOT %ERRORLEVEL%==0 GOTO ERROR


SET MSG=%DATE% %TIME% CSV取込トラン_冷凍食品_商品 INATK.CSVTOK_RSSHN BACKUP処理
ECHO %MSG%
>> %OUTFILE% ECHO %MSG%
SET OUTFILENAME=%~DP0..\DATA\INATK.CSVTOK_RSSHN
"%MYSQLPATH%mysql" %OPTION% -h %HOST% %DB_NAME% -u %USER_ID% -N -e "SELECT COALESCE(SEQ, '') || ',' || COALESCE(INPUTNO, '') || ',' || COALESCE(INPUTEDANO, '') || ',' || COALESCE(ERRCD, '') || ',' || COALESCE(ERRFLD, '') || ',' || COALESCE(ERRVL, '') || ',' || COALESCE(ERRTBLNM, '') || ',' || COALESCE(CSV_UPDKBN, '') || ',' || COALESCE(HBSTDT, '') || ',' || COALESCE(BMNCD, '') || ',' || COALESCE(WRITUKBN, '') || ',' || COALESCE(SEICUTKBN, '') || ',' || COALESCE(DUMMYCD, '') || ',' || COALESCE(KANRINO, '') || ',' || COALESCE(SHNCD, '') || ',' || COALESCE(MAKERKN, '') || ',' || COALESCE(SHNKN, '') || ',' || COALESCE(KIKKN, '') || ',' || COALESCE(IRISU, '') || ',' || COALESCE(BAIKAAM, '') || ',' || COALESCE(GENKAAM, '') || ',' || COALESCE(UPDKBN, '') || ',' || COALESCE(OPERATOR, '') || ',' || COALESCE(ADDDT, '') || ',' || COALESCE(UPDDT, '') FROM INATK.CSVTOK_RSSHN;" >%OUTFILENAME% 2>>%OUTFILE%
IF NOT %ERRORLEVEL%==0 GOTO ERROR

SET MSG=%DATE% %TIME% CSV取込トラン_冷凍食品_商品 INATK.CSVTOK_RSSHN DELETE処理
ECHO %MSG%
>> %OUTFILE% ECHO %MSG%
"%MYSQLPATH%mysql" %OPTION% -h %HOST% %DB_NAME% -u %USER_ID% --show-warnings -vv -e "DELETE FROM INATK.CSVTOK_RSSHN T1 WHERE NOT EXISTS (SELECT 1 FROM INATK.CSVTOKHEAD T2 WHERE T2.SEQ=T1.SEQ);commit;" >>%OUTFILE% 2>&1
IF NOT %ERRORLEVEL%==0 GOTO ERRO


SET MSG=%DATE% %TIME% CSV取込トラン_B/M催し送信 INATK.CSVTOK_BM BACKUP処理
ECHO %MSG%
>> %OUTFILE% ECHO %MSG%
SET OUTFILENAME=%~DP0..\DATA\INATK.CSVTOK_BM
"%MYSQLPATH%mysql" %OPTION% -h %HOST% %DB_NAME% -u %USER_ID% -N -e "SELECT COALESCE(SEQ, '') || ',' || COALESCE(INPUTNO, '') || ',' || COALESCE(ERRCD, '') || ',' || COALESCE(ERRFLD, '') || ',' || COALESCE(ERRVL, '') || ',' || COALESCE(ERRTBLNM, '') || ',' || COALESCE(CSV_UPDKBN, '') || ',' || COALESCE(MOYSKBN, '') || ',' || COALESCE(MOYSSTDT, '') || ',' || COALESCE(MOYSRBAN, '') || ',' || COALESCE(BMNNO, '') || ',' || COALESCE(BMNMAN, '') || ',' || COALESCE(BMNMKN, '') || ',' || COALESCE(HBSTDT, '') || ',' || COALESCE(HBEDDT, '') || ',' || COALESCE(BMTYP, '') || ',' || COALESCE(BAIKAAM, '') || ',' || COALESCE(BD_KOSU1, '') || ',' || COALESCE(BD_BAIKAAN1, '') || ',' || COALESCE(BD_KOSU2, '') || ',' || COALESCE(BD_BAIKAAN2, '') || ',' || COALESCE(BMNCD_RANK, '') || ',' || COALESCE(RANKNO_ADD, '') || ',' || COALESCE(RANKNO_DEL, '') || ',' || COALESCE(TENATSUK_ARR, '') || ',' || COALESCE(TENCD01_ADD, '') || ',' || COALESCE(TENCD02_ADD, '') || ',' || COALESCE(TENCD03_ADD, '') || ',' || COALESCE(TENCD04_ADD, '') || ',' || COALESCE(TENCD05_ADD, '') || ',' || COALESCE(TENCD06_ADD, '') || ',' || COALESCE(TENCD07_ADD, '') || ',' || COALESCE(TENCD08_ADD, '') || ',' || COALESCE(TENCD09_ADD, '') || ',' || COALESCE(TENCD10_ADD, '') || ',' || COALESCE(TENCD01_DEL, '') || ',' || COALESCE(TENCD02_DEL, '') || ',' || COALESCE(TENCD03_DEL, '') || ',' || COALESCE(TENCD04_DEL, '') || ',' || COALESCE(TENCD05_DEL, '') || ',' || COALESCE(TENCD06_DEL, '') || ',' || COALESCE(TENCD07_DEL, '') || ',' || COALESCE(TENCD08_DEL, '') || ',' || COALESCE(TENCD09_DEL, '') || ',' || COALESCE(TENCD10_DEL, '') || ',' || COALESCE(SHNCD, '') || ',' || COALESCE(GENKAAM, '') || ',' || COALESCE(UPDKBN, '') || ',' || COALESCE(OPERATOR, '') || ',' || COALESCE(ADDDT, '') || ',' || COALESCE(UPDDT, '') FROM INATK.CSVTOK_BM;" >%OUTFILENAME% 2>>%OUTFILE%
IF NOT %ERRORLEVEL%==0 GOTO ERRO

SET MSG=%DATE% %TIME% CSV取込トラン_B/M催し送信 INATK.CSVTOK_BM DELETE処理
ECHO %MSG%
>> %OUTFILE% ECHO %MSG%
"%MYSQLPATH%mysql" %OPTION% -h %HOST% %DB_NAME% -u %USER_ID% --show-warnings -vv -e "DELETE FROM INATK.CSVTOK_BM T1 WHERE NOT EXISTS (SELECT 1 FROM INATK.CSVTOKHEAD T2 WHERE T2.SEQ=T1.SEQ);commit;" >>%OUTFILE% 2>&1
IF NOT %ERRORLEVEL%==0 GOTO ERRO







:FINAL
EXIT /B 0

:ERROR
EXIT /B 1
