REM [026][069_LOAD]
@ECHO OFF

REM ログフォルダ作成
IF NOT EXIST %~DP0..\logs MKDIR %~DP0..\logs

REM コマンドフォルダ作成
IF NOT EXIST %~DP0..\cmd MKDIR %~DP0..\cmd

REM ログファイルの情報
SET OUTFILE=%~DP0../logs/setup.log
SET OUTTIME=%~DP0../logs/time.log

REM ベースフォルダ
SET BASEDIR=%~DP0..

REM 更新対象の情報
SET INFOSCRIPT=%~DP0..\cmd\%~N0.DB2


SET INFILENAME=
REM バックアップ
SET MSG=%DATE% %TIME% 冷凍食品_企画 INATK.TOKRS_KKK BACKUP処理
ECHO %MSG%
>> %OUTFILE% ECHO %MSG%
SET OUTFILENAME=%~DP0..\DATA\INATK.TOKRS_KKK
"%MYSQLPATH%mysql" %OPTION% -h %HOST% %DB_NAME% -u %USER_ID% -N -e "SELECT COALESCE(HBSTDT, '') || ',' || COALESCE(BMNCD, '') || ',' || COALESCE(WRITUKBN, '') || ',' || COALESCE(SEICUTKBN, '') || ',' || COALESCE(DUMMYCD, '') || ',' || COALESCE(MEISHOKN, '') || ',' || COALESCE(UPDKBN, '') || ',' || COALESCE(SENDFLG, '') || ',' || COALESCE(OPERATOR, '') FROM INATK.TOKRS_KKK;" >%OUTFILENAME% 2>>%OUTFILE%
IF NOT %ERRORLEVEL%==0 GOTO ERROR

SET MSG=%DATE% %TIME% 冷凍食品_商品 INATK.TOKRS_SHN BACKUP処理
ECHO %MSG%
>> %OUTFILE% ECHO %MSG%
SET OUTFILENAME=%~DP0..\DATA\INATK.TOKRS_SHN
"%MYSQLPATH%mysql" %OPTION% -h %HOST% %DB_NAME% -u %USER_ID% -N -e "SELECT COALESCE(HBSTDT, '') || ',' || COALESCE(BMNCD, '') || ',' || COALESCE(WRITUKBN, '') || ',' || COALESCE(SEICUTKBN, '') || ',' || COALESCE(DUMMYCD, '') || ',' || COALESCE(KANRINO, '') || ',' || COALESCE(SHNCD, '') || ',' || COALESCE(MAKERKN, '') || ',' || COALESCE(SHNKN, '') || ',' || COALESCE(KIKKN, '') || ',' || COALESCE(IRISU, '') || ',' || COALESCE(BAIKAAM, '') || ',' || COALESCE(GENKAAM, '') || ',' || COALESCE(UPDKBN, '') || ',' || COALESCE(SENDFLG, '') || ',' || COALESCE(OPERATOR, '') || ',' || COALESCE(ADDDT, '') || ',' || COALESCE(UPDDT, '') FROM INATK.TOKRS_SHN;" >%OUTFILENAME% 2>>%OUTFILE%
IF NOT %ERRORLEVEL%==0 GOTO ERROR

SET MSG=%DATE% %TIME% 冷凍食品内部管理 INATK.SYSRS BACKUP処理
ECHO %MSG%
>> %OUTFILE% ECHO %MSG%
SET OUTFILENAME=%~DP0..\DATA\INATK.SYSRS
"%MYSQLPATH%mysql" %OPTION% -h %HOST% %DB_NAME% -u %USER_ID% -N -e "SELECT COALESCE(HBSTDT, '') || ',' || COALESCE(BMNCD, '') || ',' || COALESCE(WRITUKBN, '') || ',' || COALESCE(SEICUTKBN, '') || ',' || COALESCE(DUMMYCD, '') || ',' || COALESCE(SUMI_KANRINO, '') || ',' || COALESCE(OPERATOR, '') || ',' || COALESCE(ADDDT, '') || ',' || COALESCE(UPDDT, '') FROM INATK.SYSRS;" >%OUTFILENAME% 2>>%OUTFILE%
IF NOT %ERRORLEVEL%==0 GOTO ERROR


REM 削除
SET MSG=%DATE% %TIME% 冷凍食品_企画 INATK.TOKRS_KKK DELETE処理
ECHO %MSG%
>> %OUTFILE% ECHO %MSG%
"%MYSQLPATH%mysql" %OPTION% -h %HOST% %DB_NAME% -u %USER_ID% --show-warnings -vv -e "DELETE FROM INATK.TOKRS_KKK X1 WHERE EXISTS (SELECT 1 FROM (SELECT * FROM (SELECT X1.DUMMYCD, X1.HBSTDT, RANK() OVER (PARTITION BY X1.DUMMYCD ORDER BY X1.HBSTDT DESC) AS RANKS FROM (SELECT DISTINCT T1.DUMMYCD, T1.HBSTDT FROM INATK.TOKRS_KKK T1 WHERE EXISTS (SELECT 1 FROM (SELECT CAST(DATE_FORMAT(DATE_FORMAT(SHORIDT, '%%Y%%m%%d') - INTERVAL 1 DAY - INTERVAL X.MWDSU DAY, '%%Y%%m%%d') AS SIGNED) AS SHORIDT FROM INAAD.SYSSHORIDT, (SELECT MWDSU FROM INAAD.SYSTOKDELCTL WHERE P_TABLENM = 'TOKRS_KKK' AND PTNCD = '1') X) T2 WHERE T1.HBSTDT < T2.SHORIDT AND T1.SENDFLG = 1)) X1) X WHERE RANKS > 4) X2 WHERE X2.HBSTDT = X1.HBSTDT AND X2.DUMMYCD = X1.DUMMYCD);commit;" >>%OUTFILE% 2>&1
IF %ERRORLEVEL% GTR 1 GOTO ERROR

SET MSG=%DATE% %TIME% 冷凍食品_商品 INATK.TOKRS_SHN DELETE処理
ECHO %MSG%
>> %OUTFILE% ECHO %MSG%
"%MYSQLPATH%mysql" %OPTION% -h %HOST% %DB_NAME% -u %USER_ID% --show-warnings -vv -e "DELETE FROM INATK.TOKRS_SHN T1 WHERE NOT EXISTS (SELECT 1 FROM INATK.TOKRS_KKK T2 WHERE T2.HBSTDT=T1.HBSTDT AND T2.BMNCD=T1.BMNCD AND T2.WRITUKBN=T1.WRITUKBN AND T2.SEICUTKBN=T1.SEICUTKBN AND T2.DUMMYCD=T1.DUMMYCD);commit;" >>%OUTFILE% 2>&1
IF %ERRORLEVEL% GTR 1 GOTO ERROR


SET MSG=%DATE% %TIME% 冷凍食品内部管理 INATK.SYSRS DELETE処理
ECHO %MSG%
>> %OUTFILE% ECHO %MSG%
"%MYSQLPATH%mysql" %OPTION% -h %HOST% %DB_NAME% -u %USER_ID% --show-warnings -vv -e"DELETE FROM INATK.SYSRS T1 WHERE NOT EXISTS (SELECT 1 FROM INATK.TOKRS_KKK T2 WHERE T2.HBSTDT=T1.HBSTDT AND T2.BMNCD=T1.BMNCD AND T2.WRITUKBN=T1.WRITUKBN AND T2.SEICUTKBN=T1.SEICUTKBN AND T2.DUMMYCD=T1.DUMMYCD);commit;" >>%OUTFILE% 2>&1
IF %ERRORLEVEL% GTR 1 GOTO ERROR



:FINAL
EXIT /B 0

:ERROR
EXIT /B 1
