REM [026][A11#DD26DELETE]
@ECHO OFF

REM ログフォルダ作成
IF NOT EXIST %~DP0..\logs MKDIR %~DP0..\logs

REM コマンドフォルダ作成
IF NOT EXIST %~DP0..\cmd MKDIR %~DP0..\cmd

REM ログファイルの情報
SET OUTFILE=%~DP0../logs/setup.log
SET OUTTIME=%~DP0../logs/time.log

REM ベースフォルダ
SET BASEDIR=%~DP0..

REM 更新対象の情報
SET INFOSCRIPT=%~DP0..\cmd\%~N0.DB2

SET MSG=%DATE% %TIME% A11#DD26 定量マスタ定期削除処理
ECHO %MSG%
>> %OUTFILE% ECHO %MSG%


SET MSG=%DATE% %TIME% 構成ページ削除基準管理 INAIF.KOPAGE_KNR MERGE処理
REM WKテーブルに一時退避
"%MYSQLPATH%mysql" %OPTION% -h %HOST% %DB_NAME% -u %USER_ID% --show-warnings -vv -e "TRUNCATE TABLE INAWK.KOPAGE_KNR; INSERT IGNORE INTO INAWK.KOPAGE_KNR SELECT * FROM INAIF.KOPAGE_KNR; commit;" >>%OUTFILE% 2>&1
IF NOT %ERRORLEVEL%==0 GOTO ERROR
"%MYSQLPATH%mysql" %OPTION% -h %HOST% %DB_NAME% -u %USER_ID% --show-warnings -vv -e "ANALYZE TABLE INAWK.KOPAGE_KNR;" >>%OUTFILE% 2>&1
IF ERRORLEVEL 1 GOTO ERROR

REM 更新
"%MYSQLPATH%mysql" %OPTION% -h %HOST% %DB_NAME% -u %USER_ID% --show-warnings -vv -e "TRUNCATE TABLE INAIF.KOPAGE_KNR; INSERT IGNORE INTO INAIF.KOPAGE_KNR SELECT COALESCE(K.SHOCD, M.SHNCD) AS SHOCD, CAST(NULL AS SIGNED) AS BINKBN, CASE WHEN M.SHNCD IS NULL THEN CASE WHEN K.KO_DEL_DATE = 0 THEN S.DT_INT ELSE K.KO_DEL_DATE END ELSE 0 END AS KO_DEL_DATE, CASE WHEN M.SHNCD IS NULL THEN K.DELKBN ELSE 0 END AS DELKBN, CAST(CASE WHEN M.SHNCD IS NULL THEN K.FILLER ELSE NULL END AS CHAR (12)) AS FILLER FROM INAWK.KOPAGE_KNR K LEFT OUTER JOIN (SELECT DISTINCT RIGHT ('00000000' || SHNCD, 8) AS SHNCD FROM INAMS2.MSTKSPAGE) M ON K.SHOCD = M.SHNCD INNER JOIN INAPARM.SYSBATCHDT S ON S.SMODE = 'DAILY' WHERE CASE WHEN M.SHNCD IS NULL AND K.DELKBN = 1 THEN 1 ELSE 0 END = 0 UNION SELECT COALESCE(K.SHOCD, M.SHNCD) AS SHOCD, CAST(NULL AS SIGNED) AS BINKBN, CASE WHEN M.SHNCD IS NULL THEN CASE WHEN K.KO_DEL_DATE = 0 THEN S.DT_INT ELSE K.KO_DEL_DATE END ELSE 0 END AS KO_DEL_DATE, CASE WHEN M.SHNCD IS NULL THEN K.DELKBN ELSE 0 END AS DELKBN, CAST(CASE WHEN M.SHNCD IS NULL THEN K.FILLER ELSE NULL END AS CHAR (12)) AS FILLER FROM INAWK.KOPAGE_KNR K RIGHT OUTER JOIN (SELECT DISTINCT RIGHT ('00000000' || SHNCD, 8) AS SHNCD FROM INAMS2.MSTKSPAGE) M ON K.SHOCD = M.SHNCD INNER JOIN INAPARM.SYSBATCHDT S ON S.SMODE = 'DAILY' WHERE CASE WHEN M.SHNCD IS NULL AND K.DELKBN = 1 THEN 1 ELSE 0 END = 0; commit;" >>%OUTFILE% 2>&1
IF NOT %ERRORLEVEL%==0 GOTO ERROR
"%MYSQLPATH%mysql" %OPTION% -h %HOST% %DB_NAME% -u %USER_ID% --show-warnings -vv -e "ANALYZE TABLE INAIF.KOPAGE_KNR;" >>%OUTFILE% 2>&1
IF ERRORLEVEL 1 GOTO ERROR


REM 削除

SET MSG=%DATE% %TIME% 正規定量_商品 INATK2.HATSTR_SHN DELETEKEY処理1-商品基本マスタ参照
ECHO %MSG%
>> %OUTFILE% ECHO %MSG%
"%MYSQLPATH%mysql" %OPTION% -h %HOST% %DB_NAME% -u %USER_ID% --show-warnings -vv -e "TRUNCATE TABLE INAWK.TEIRYO_SHN_DELKEY;INSERT IGNORE INTO INAWK.TEIRYO_SHN_DELKEY SELECT TRIM(SHNCD), 1 FROM INATK2.HATSTR_SHN H WHERE NOT EXISTS (SELECT * FROM INAMS.MSTSHN M WHERE H.SHNCD = M.SHNCD); commit;" >>%OUTFILE% 2>&1
IF ERRORLEVEL 1 GOTO ERROR

SET MSG=%DATE% %TIME% 正規定量_商品 INATK2.HATSTR_SHN DELETEKEY処理2-構成ページ削除基準管理参照
ECHO %MSG%
>> %OUTFILE% ECHO %MSG%
"%MYSQLPATH%mysql" %OPTION% -h %HOST% %DB_NAME% -u %USER_ID% --show-warnings -vv -e "INSERT IGNORE INTO INAWK.TEIRYO_SHN_DELKEY SELECT TRIM(H.SHNCD), 2 FROM INATK2.HATSTR_SHN H WHERE EXISTS (SELECT * FROM INAIF.KOPAGE_KNR K INNER JOIN INAPARM.SYSBATCHDT S ON S.SMODE = 'DAILY' WHERE TRIM(H.SHNCD) = K.SHOCD AND K.KO_DEL_DATE > 0 AND DATE_FORMAT(K.KO_DEL_DATE, '%%Y%%m%%d') + INTERVAL 28 DAY <= S.DT); commit;" >>%OUTFILE% 2>&1
IF NOT %ERRORLEVEL%==0 GOTO ERROR

SET MSG=%DATE% %TIME% 正規定量_商品 INATK2.HATSTR_SHN DELETE処理
ECHO %MSG%
>> %OUTFILE% ECHO %MSG%
"%MYSQLPATH%mysql" %OPTION% -h %HOST% %DB_NAME% -u %USER_ID% --show-warnings -vv -e "DELETE FROM INATK2.HATSTR_SHN H WHERE EXISTS (SELECT * FROM INAWK.TEIRYO_SHN_DELKEY HD WHERE H.SHNCD = HD.SHOCD);commit;" >>%OUTFILE% 2>&1
IF %ERRORLEVEL% GTR 1 GOTO ERROR

SET MSG=%DATE% %TIME% 正規定量_店別数量 INATK2.HATSTR_TEN DELETE処理
ECHO %MSG%
>> %OUTFILE% ECHO %MSG%
"%MYSQLPATH%mysql" %OPTION% -h %HOST% %DB_NAME% -u %USER_ID% --show-warnings -vv -e "DELETE FROM INATK2.HATSTR_TEN H WHERE EXISTS (SELECT * FROM INAWK.TEIRYO_SHN_DELKEY HD WHERE H.SHNCD = HD.SHOCD);commit;" >>%OUTFILE% 2>&1
IF %ERRORLEVEL% GTR 1 GOTO ERROR

SET MSG=%DATE% %TIME% 正規定量_店別納入日指定 INATK2.HATSTR_NNDT DELETE処理
ECHO %MSG%
>> %OUTFILE% ECHO %MSG%
"%MYSQLPATH%mysql" %OPTION% -h %HOST% %DB_NAME% -u %USER_ID% --show-warnings -vv -e "DELETE FROM INATK2.HATSTR_NNDT H WHERE EXISTS (SELECT * FROM INAWK.TEIRYO_SHN_DELKEY HD WHERE H.SHNCD = HD.SHOCD);commit;" >>%OUTFILE% 2>&1
IF %ERRORLEVEL% GTR 1 GOTO ERROR

SET MSG=%DATE% %TIME% 次週定量_店別数量 INATK2.HATJTR_TEN DELETE処理
ECHO %MSG%
>> %OUTFILE% ECHO %MSG%
"%MYSQLPATH%mysql" %OPTION% -h %HOST% %DB_NAME% -u %USER_ID% --show-warnings -vv -e "DELETE FROM INATK2.HATJTR_TEN H WHERE EXISTS (SELECT * FROM INAWK.TEIRYO_SHN_DELKEY HD WHERE H.SHNCD = HD.SHOCD);commit;" >>%OUTFILE% 2>&1
IF %ERRORLEVEL% GTR 1 GOTO ERROR

SET MSG=%DATE% %TIME% 次週定量_店別数量 INATK2.HATJTR_TEN
ECHO %MSG%
SET OUTFILENAME=%~DP0..\DATA\INATK2.HATJTR_TEN.WEEKNO
"%MYSQLPATH%mysql" %OPTION% -h %HOST% %DB_NAME% -u %USER_ID% -N -e "SELECT RPAD(SHNCD, 14, ' ') || ',' || COALESCE(BINKBN, '') || ',' || COALESCE(TENCD, '') || ',' || COALESCE(SHUNO, '') || ',' || COALESCE(SURYO_MON, '') || ',' || COALESCE(SURYO_TUE, '') || ',' || COALESCE(SURYO_WED, '') || ',' || COALESCE(SURYO_THU, '') || ',' || COALESCE(SURYO_FRI, '') || ',' || COALESCE(SURYO_SAT, '') || ',' || COALESCE(SURYO_SUN, '') || ',' || COALESCE(SENDFLG, '') || ',' || COALESCE(OPERATOR, '') || ',' || COALESCE(ADDDT, '') || ',' || COALESCE(UPDDT, '') FROM INATK2.HATJTR_TEN;" >%OUTFILENAME% 2>>%OUTFILE%
IF NOT %ERRORLEVEL%==0 GOTO ERROR

SET MSG=%DATE% %TIME% 次週定量_店別数量 INATK2.HATJTR_TEN DELETE処理 週No
ECHO %MSG%
>> %OUTFILE% ECHO %MSG%
"%MYSQLPATH%mysql" %OPTION% -h %HOST% %DB_NAME% -u %USER_ID% --show-warnings -vv -e "DELETE FROM INATK2.HATJTR_TEN WHERE SHUNO < (SELECT SHUNO FROM INAAD.SYSSHUNO WHERE (SELECT CAST(DATE_FORMAT(DATE_FORMAT(SHORIDT, '%%Y%%m%%d') - INTERVAL 1 MONTH + INTERVAL 1 DAY, '%%Y%%m%%d') AS SIGNED) FROM INAAD.SYSSHORIDT WHERE ID = 6) BETWEEN STARTDT AND ENDDT) AND 4 = (SELECT DAYOFWEEK(DATE_FORMAT(SHORIDT, '%%Y%%m%%d')) FROM INAAD.SYSSHORIDT WHERE ID = 6); commit;" >>%OUTFILE% 2>&1

REM 更新
SET MSG=%DATE% %TIME% 構成ページ削除基準管理 INAIF.KOPAGE_KNR UPDATE処理
ECHO %MSG%
>> %OUTFILE% ECHO %MSG%
"%MYSQLPATH%mysql" %OPTION% -h %HOST% %DB_NAME% -u %USER_ID% --show-warnings -vv -e "UPDATE INAIF.KOPAGE_KNR KK SET DELKBN = 1 WHERE EXISTS (SELECT * FROM INAWK.TEIRYO_SHN_DELKEY TD WHERE KK.SHOCD = TD.SHOCD AND TD.KBN = 2); commit;" >>%OUTFILE% 2>&1
IF ERRORLEVEL 1 GOTO ERROR

SET INFILENAME=
SET MSG=%DATE% %TIME% 定量テーブルMD送信
ECHO %MSG%
>> %OUTFILE% ECHO %MSG% 正規定量_商品 INATK2.HATSTR_SHN
SET EXPFILENAME=%~DP0..\DATA\INATK2.HATSTR_SHN
"%MYSQLPATH%mysql" %OPTION% -h %HOST% %DB_NAME% -u %USER_ID% -N -e "SELECT  RPAD(SHNCD, 14, ' ') || ',' || COALESCE(BINKBN, '') || ',' || COALESCE(TSKBN_MON, '') || ',' || COALESCE(TSKBN_TUE, '') || ',' || COALESCE(TSKBN_WED, '') || ',' || COALESCE(TSKBN_THU, '') || ',' || COALESCE(TSKBN_FRI, '') || ',' || COALESCE(TSKBN_SAT, '') || ',' || COALESCE(TSKBN_SUN, '') || ',' || COALESCE(UPDKBN, '') || ',' || COALESCE(SENDFLG, '') || ',' || COALESCE(OPERATOR, '') || ',' || DATE_FORMAT(COALESCE(ADDDT, ''), '%%Y-%%m-%%d-%%k.%%i.%%S.%%f') || ',' || DATE_FORMAT(COALESCE(UPDDT, ''), '%%Y-%%m-%%d-%%k.%%i.%%S.%%f') || ',' || COALESCE(bat_delcnt, '') FROM INATK2.HATSTR_SHN;" >%EXPFILENAME% 2>>%OUTFILE%

>> %OUTFILE% ECHO %MSG% 正規定量_店別数量 INATK2.HATSTR_TEN
SET EXPFILENAME=%~DP0..\DATA\INATK2.HATSTR_TEN
"%MYSQLPATH%mysql" %OPTION% -h %HOST% %DB_NAME% -u %USER_ID% -N -e "SELECT  RPAD(SHNCD, 14, ' ') || ',' || COALESCE(BINKBN, '') || ',' || COALESCE(TENCD, '') || ',' || COALESCE(SURYO_MON, '') || ',' || COALESCE(SURYO_TUE, '') || ',' || COALESCE(SURYO_WED, '') || ',' || COALESCE(SURYO_THU, '') || ',' || COALESCE(SURYO_FRI, '') || ',' || COALESCE(SURYO_SAT, '') || ',' || COALESCE(SURYO_SUN, '') || ',' || COALESCE(UPDKBN, '') || ',' || COALESCE(SENDFLG, '') || ',' || COALESCE(OPERATOR, '') || ',' || DATE_FORMAT(COALESCE(ADDDT, ''), '%%Y-%%m-%%d-%%k.%%i.%%S.%%f') || ',' || DATE_FORMAT(COALESCE(UPDDT, ''), '%%Y-%%m-%%d-%%k.%%i.%%S.%%f')  FROM INATK2.HATSTR_TEN;">%EXPFILENAME% 2>>%OUTFILE%

>> %OUTFILE% ECHO %MSG% 正規定量_店別納入日指定 INATK2.HATSTR_NNDT
SET EXPFILENAME=%~DP0..\DATA\INATK2.HATSTR_NNDT
"%MYSQLPATH%mysql" %OPTION% -h %HOST% %DB_NAME% -u %USER_ID% -N -e "SELECT  RPAD(SHNCD, 14, ' ') || ',' || COALESCE(BINKBN, '') || ',' || COALESCE(NNDT, '') || ',' || COALESCE(TENCD, '') || ',' || COALESCE(SURYO, '') || ',' || COALESCE(UPDKBN, '') || ',' || COALESCE(SENDFLG, '') || ',' || COALESCE(OPERATOR, '') || ',' || DATE_FORMAT(COALESCE(ADDDT, ''), '%%Y-%%m-%%d-%%k.%%i.%%S.%%f') || ',' || DATE_FORMAT(COALESCE(UPDDT, ''), '%%Y-%%m-%%d-%%k.%%i.%%S.%%f') FROM INATK2.HATSTR_NNDT;" >%EXPFILENAME% 2>>%OUTFILE%

>> %OUTFILE% ECHO %MSG% 次週定量_店別数量 INATK2.HATJTR_TEN
SET EXPFILENAME=%~DP0..\DATA\INATK2.HATJTR_TEN
"%MYSQLPATH%mysql" %OPTION% -h %HOST% %DB_NAME% -u %USER_ID% -N -e "SELECT  RPAD(SHNCD, 14, ' ') || ',' || COALESCE(BINKBN, '') || ',' || COALESCE(TENCD, '') || ',' || COALESCE(SHUNO, '') || ',' || COALESCE(SURYO_MON, '') || ',' || COALESCE(SURYO_TUE, '') || ',' || COALESCE(SURYO_WED, '') || COALESCE(9, '') || COALESCE(SURYO_THU, '') || ',' || COALESCE(SURYO_FRI, '') || ',' || COALESCE(SURYO_SAT, '') || ',' || COALESCE(SURYO_SUN, '') || ',' || COALESCE(SENDFLG, '') || ',' || COALESCE(OPERATOR, '') || ',' || DATE_FORMAT(COALESCE(ADDDT, ''), '%%Y-%%m-%%d-%%k.%%i.%%S.%%f') || ',' || DATE_FORMAT(COALESCE(UPDDT, ''), '%%Y-%%m-%%d-%%k.%%i.%%S.%%f')  FROM INATK2.HATJTR_TEN;" >%EXPFILENAME% 2>>%OUTFILE%

:FINAL
EXIT /B 0

:ERROR
EXIT /B 1
