SELECT *
FROM INATK.TOKRS_KKK X1
WHERE EXISTS (
SELECT 1 FROM (
SELECT * FROM (
SELECT
X1.DUMMYCD,X1.HBSTDT, RANK() OVER(PARTITION BY X1.DUMMYCD ORDER BY X1.HBSTDT DESC) AS RANKS
FROM (
SELECT DISTINCT T1.DUMMYCD,T1.HBSTDT
FROM INATK.TOKRS_KKK T1
WHERE EXISTS (SELECT 1 FROM (
SELECT CAST(DATE_FORMAT(DATE_FORMAT(SHORIDT, '%%Y%%m%%d') - INTERVAL 1 DAY - INTERVAL X.MWDSU DAY, '%%Y%%m%%d') AS SIGNED) AS SHORIDT FROM INAAD.SYSSHORIDT
, (SELECT MWDSU FROM INAAD.SYSTOKDELCTL WHERE P_TABLENM = 'TOKRS_KKK' AND PTNCD = '1') X
) T2 WHERE T1.HBSTDT < T2.SHORIDT AND T1.SENDFLG=1)
) X1
)X WHERE RANKS>4
)X2 WHERE X2.HBSTDT=X1.HBSTDT AND X2.DUMMYCD=X1.DUMMYCD)
;
