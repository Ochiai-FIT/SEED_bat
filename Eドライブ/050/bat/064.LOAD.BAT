REM [026][069_LOAD]
@ECHO OFF

REM ログフォルダ作成
IF NOT EXIST %~DP0..\logs MKDIR %~DP0..\logs

REM コマンドフォルダ作成
IF NOT EXIST %~DP0..\cmd MKDIR %~DP0..\cmd

REM ログファイルの情報
SET OUTFILE=%~DP0../logs/setup.log
SET OUTTIME=%~DP0../logs/time.log

REM ベースフォルダ
SET BASEDIR=%~DP0..

REM 更新対象の情報
SET INFOSCRIPT=%~DP0..\cmd\%~N0.DB2


SET INFILENAME=
SET MSG=%DATE% %TIME% 催し検索_商品 INATK.TOKMM_SHN LOAD処理
ECHO %MSG%
>> %OUTFILE% ECHO %MSG%

"%MYSQLPATH%mysql" %OPTION% -h %HOST% %DB_NAME% -u %USER_ID% --show-warnings -vv -e "TRUNCATE TABLE INATK.TOKMM_SHN; INSERT IGNORE INTO INATK.TOKMM_SHN (SELECT D1.MOYSKBN, D1.MOYSSTDT, D1.MOYSRBAN, 0 AS BMFG, 0 AS BMNO, D1.BMNCD, D1.KANRINO, D1.SHNCD, CASE WHEN LENGTH(TRIM(D2.PARNO)) <> 0 THEN D2.PARNO END AS PARNO, CASE WHEN D2.CHLDNO <> 0 THEN D2.CHLDNO END AS CHLDNO, D2.ADDSHUKBN, CASE WHEN D2.HBSTDT <> 0 THEN D2.HBSTDT END AS HBSTDT, CASE WHEN D2.HBEDDT <> 0 THEN D2.HBEDDT END AS HBEDDT, CASE WHEN D2.NNSTDT <> 0 THEN D2.NNSTDT END AS NNSTDT, CASE WHEN D2.NNEDDT <> 0 THEN D2.NNEDDT END AS NNEDDT, 'BATCH' AS OP, CURRENT_TIMESTAMP AS ADT, CURRENT_TIMESTAMP AS UDT FROM (SELECT DISTINCT MOYSCD, MOYSKBN, MOYSSTDT, MOYSRBAN, BMNCD, KANRINO, SHNCD FROM INAIF.AN_HANBAI_AFT WHERE UPDKBN = 0 AND TENSAIFLG <> 0 AND ((GTSIMECHGKBN = 1 AND GTSIMEOKFLG = 1) OR (GTSIMECHGKBN = 2 AND GTSIMEOKFLG = 1) OR (GTSIMECHGKBN = 3 AND GTSIMEOKFLG = 0) OR (GTSIMECHGKBN = 4 AND GTSIMEOKFLG = 1) OR (GTSIMECHGKBN = 0 AND GTSIMEOKFLG = 0)) UNION SELECT DISTINCT MOYSCD, MOYSKBN, MOYSSTDT, MOYSRBAN, BMNCD, KANRINO, SHNCD FROM INAIF.AN_NOUNYU_AFT WHERE UPDKBN IN (0, 8) AND ((GTSIMECHGKBN = 1 AND GTSIMEOKFLG = 1) OR (GTSIMECHGKBN = 2 AND GTSIMEOKFLG = 1) OR (GTSIMECHGKBN = 3 AND GTSIMEOKFLG = 0) OR (GTSIMECHGKBN = 4 AND GTSIMEOKFLG = 1) OR (GTSIMECHGKBN = 0 AND GTSIMEOKFLG = 0))) D1 INNER JOIN INATK.TOKTG_SHN D2 ON (D1.MOYSKBN = D2.MOYSKBN AND D1.MOYSSTDT = D2.MOYSSTDT AND D1.MOYSRBAN = D2.MOYSRBAN AND D1.BMNCD = D2.BMNCD AND D1.KANRINO = D2.KANRINO AND D1.SHNCD = D2.SHNCD) UNION ALL SELECT D1.MOYSKBN, D1.MOYSSTDT, D1.MOYSRBAN, 0 AS BMFG, 0 AS BMNO, D1.BMNCD, D1.KANRINO, D1.SHNCD, CASE WHEN LENGTH(TRIM(D2.PARNO)) <> 0 THEN D2.PARNO END AS PARNO, CASE WHEN D2.CHLDNO <> 0 THEN D2.CHLDNO END AS CHLDNO, D2.ADDSHUKBN, CASE WHEN D2.HBSTDT <> 0 THEN D2.HBSTDT END AS HBSTDT, CASE WHEN D2.HBEDDT <> 0 THEN D2.HBEDDT END AS HBEDDT, CASE WHEN D2.NNSTDT <> 0 THEN D2.NNSTDT END AS NNSTDT, CASE WHEN D2.NNEDDT <> 0 THEN D2.NNEDDT END AS NNEDDT, 'BATCH' AS OP, CURRENT_TIMESTAMP AS ADT, CURRENT_TIMESTAMP AS UDT FROM (SELECT DISTINCT MOYSCD, MOYSKBN, MOYSSTDT, MOYSRBAN, BMNCD, KANRINO, SHNCD FROM INAIF.AN_HANBAI_NEQ WHERE UPDKBN = 0 AND TENSAIFLG <> 0 AND ((GTSIMECHGKBN = 1 AND GTSIMEOKFLG = 1) OR (GTSIMECHGKBN = 2 AND GTSIMEOKFLG = 1) OR (GTSIMECHGKBN = 3 AND GTSIMEOKFLG = 0) OR (GTSIMECHGKBN = 4 AND GTSIMEOKFLG = 1) OR (GTSIMECHGKBN = 0 AND GTSIMEOKFLG = 0)) UNION SELECT DISTINCT MOYSCD, MOYSKBN, MOYSSTDT, MOYSRBAN, BMNCD, KANRINO, SHNCD FROM INAIF.AN_NOUNYU_NEQ WHERE UPDKBN IN (0, 8) AND ((GTSIMECHGKBN = 1 AND GTSIMEOKFLG = 1) OR (GTSIMECHGKBN = 2 AND GTSIMEOKFLG = 1) OR (GTSIMECHGKBN = 3 AND GTSIMEOKFLG = 0) OR (GTSIMECHGKBN = 4 AND GTSIMEOKFLG = 1) OR (GTSIMECHGKBN = 0 AND GTSIMEOKFLG = 0))) D1 INNER JOIN INATK.TOKSP_SHN D2 ON (D1.MOYSKBN = D2.MOYSKBN AND D1.MOYSSTDT = D2.MOYSSTDT AND D1.MOYSRBAN = D2.MOYSRBAN AND D1.BMNCD = D2.BMNCD AND D1.KANRINO = D2.KANRINO AND D1.SHNCD = D2.SHNCD) UNION ALL SELECT DISTINCT D1.MOYSKBN, D1.MOYSSTDT, D1.MOYSRBAN, 1 AS BMFG, D1.BMNCD AS BMNO, D1.BMNO AS BMNCD, D1.KANRINO, D1.SHNCD, '000' AS PARNO, CAST(NULL AS SIGNED) AS CHLDNO, CAST(NULL AS SIGNED) AS ADDSHUKBN, CASE WHEN D1.HBSTDT <> 0 THEN D1.HBSTDT END AS HBSTDT, CASE WHEN D1.HBEDDT <> 0 THEN D1.HBEDDT END AS HBEDDT, CAST(NULL AS SIGNED) AS NNSTDT, CAST(NULL AS SIGNED) AS NNEDDT, 'BATCH' AS OP, CURRENT_TIMESTAMP AS ADT, CURRENT_TIMESTAMP AS UDT FROM INAIF.MS_HANBAI_BMS D1 INNER JOIN INATK.TOKMOYCD D2 ON D1.MOYSKBN = D2.MOYSKBN AND D1.MOYSSTDT = D2.MOYSSTDT AND D1.MOYSRBAN = D2.MOYSRBAN WHERE D1.UPDKBN = 0 UNION ALL SELECT DISTINCT D1.MOYSKBN, D1.MOYSSTDT, D1.MOYSRBAN, 0 AS BMFG, 0 AS BMNO, D1.BMNCD, D1.KANRINO, D1.SHNCD, '000' AS PARNO, CAST(NULL AS SIGNED) AS CHLDNO, CAST(NULL AS SIGNED) AS ADDSHUKBN, CASE WHEN D2.HBSTDT <> 0 THEN D2.HBSTDT END AS HBSTDT, CASE WHEN D2.HBEDDT <> 0 THEN D2.HBEDDT END AS HBEDDT, CASE WHEN D2.NNSTDT <> 0 THEN D2.NNSTDT END AS HBSTDT, CASE WHEN D2.NNEDDT <> 0 THEN D2.NNEDDT END AS HBEDDT, 'BATCH' AS OP, CURRENT_TIMESTAMP AS ADT, CURRENT_TIMESTAMP AS UDT FROM INATK.TOKSO_SHN D1 INNER JOIN INATK.TOKMOYCD D2 ON D1.MOYSKBN = D2.MOYSKBN AND D1.MOYSSTDT = D2.MOYSSTDT AND D1.MOYSRBAN = D2.MOYSRBAN WHERE D1.UPDKBN = 0 UNION ALL SELECT DISTINCT D1.MOYSKBN, D1.MOYSSTDT, D1.MOYSRBAN, 0 AS BMFG, 0 AS BMNO, CAST('0' || SUBSTR(D1.SHNCD, 1, 2) AS SIGNED) AS BMNCD, D1.KANRINO, D1.SHNCD, '000' AS PARNO, CAST(NULL AS SIGNED) AS CHLDNO, CAST(NULL AS SIGNED) AS ADDSHUKBN, CASE WHEN D2.HBSTDT <> 0 THEN D2.HBSTDT END AS HBSTDT, CASE WHEN D2.HBEDDT <> 0 THEN D2.HBEDDT END AS HBEDDT, CASE WHEN D2.NNSTDT <> 0 THEN D2.NNSTDT END AS HBSTDT, CASE WHEN D2.NNEDDT <> 0 THEN D2.NNEDDT END AS HBEDDT, 'BATCH' AS OP, CURRENT_TIMESTAMP AS ADT, CURRENT_TIMESTAMP AS UDT FROM INATK.TOKJU_SHN D1 INNER JOIN INATK.TOKMOYCD D2 ON D1.MOYSKBN = D2.MOYSKBN AND D1.MOYSSTDT = D2.MOYSSTDT AND D1.MOYSRBAN = D2.MOYSRBAN WHERE D1.UPDKBN = 0 UNION ALL SELECT DISTINCT D1.MOYSKBN, D1.MOYSSTDT, D1.MOYSRBAN, 0 AS BMFG, 0 AS BMNO, CAST('0' || SUBSTR(D1.SHNCD, 1, 2) AS SIGNED) AS BMNCD, D1.KANRINO, D1.SHNCD, '000' AS PARNO, CAST(NULL AS SIGNED) AS CHLDNO, CAST(NULL AS SIGNED) AS ADDSHUKBN, CASE WHEN D2.HBSTDT <> 0 THEN D2.HBSTDT END AS HBSTDT, CASE WHEN D2.HBEDDT <> 0 THEN D2.HBEDDT END AS HBEDDT, CASE WHEN D2.NNSTDT <> 0 THEN D2.NNSTDT END AS HBSTDT, CASE WHEN D2.NNEDDT <> 0 THEN D2.NNEDDT END AS HBEDDT, 'BATCH' AS OP, CURRENT_TIMESTAMP AS ADT, CURRENT_TIMESTAMP AS UDT FROM INATK.TOKQJU_SHN D1 INNER JOIN INATK.TOKMOYCD D2 ON D1.MOYSKBN = D2.MOYSKBN AND D1.MOYSSTDT = D2.MOYSSTDT AND D1.MOYSRBAN = D2.MOYSRBAN WHERE D1.UPDKBN = 0);commit;" >>%OUTFILE% 2>&1

IF ERRORLEVEL 1 GOTO ERROR

"%MYSQLPATH%mysql" %OPTION% -h %HOST% %DB_NAME% -u %USER_ID% --show-warnings -vv -e "ANALYZE TABLE INAPRE.MSTSHN_LT;" >>%OUTFILE% 2>&1
IF ERRORLEVEL 1 GOTO ERROR


SET OUTFILENAME=%~DP0..\DATA\INATK.TOKMM_SHN
ECHO %OUTFILENAME% >> %OUTFILE%
"%MYSQLPATH%mysql" %OPTION% -h %HOST% %DB_NAME% -u %USER_ID% -N -e "SELECT COALESCE(MOYSKBN,'')||','||COALESCE(MOYSSTDT,'')||','||COALESCE(MOYSRBAN,'')||','||COALESCE(BMFLG,'')||','||COALESCE(BMNO,'')||','||COALESCE(BMNCD,'')||','||COALESCE(KANRINO,'')||','||COALESCE(SHNCD,'')||','||COALESCE(PARNO,'')||','||COALESCE(CHLDNO,'')||','||COALESCE(ADDSHUKBN,'')||','||COALESCE(HBSTDT,'')||','||COALESCE(HBEDDT,'')||','||COALESCE(NNSTDT,'')||','||COALESCE(NNEDDT,'')||','||COALESCE(OPERATOR,'')||','||COALESCE(ADDDT,'')||','||COALESCE(UPDDT,'') FROM INATK.TOKMM_SHN;" >%OUTFILENAME% 2>>%OUTFILE%
IF NOT %ERRORLEVEL%==0 GOTO ERROR

:FINAL
EXIT /B 0

:ERROR
EXIT /B 1
