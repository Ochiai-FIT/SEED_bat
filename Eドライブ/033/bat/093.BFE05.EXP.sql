WITH SHN_Y AS (SELECT SHN_Y.*, CASE WHEN TMP.YOYAKUDT2 IS NOT NULL THEN CAST(DATE_FORMAT(CAST(CAST(TMP.YOYAKUDT2 AS CHAR) AS DATETIME) - INTERVAL 1 DAY, '%Y%m%d') AS SIGNED) ELSE 99999999 END AS YOYAKUDT2 FROM INAMS2.MSTSHN_Y SHN_Y INNER JOIN (SELECT SHN_Y.SHNCD, SHN_Y.YOYAKUDT, MAX(SHN_Y2.YOYAKUDT) AS YOYAKUDT2 FROM INAMS2.MSTSHN_Y SHN_Y LEFT OUTER JOIN (SELECT * FROM INAMS2.MSTSHN_Y WHERE UPDKBN <> 1) SHN_Y2 ON SHN_Y.SHNCD = SHN_Y2.SHNCD AND SHN_Y.YOYAKUDT < SHN_Y2.YOYAKUDT WHERE SHN_Y.UPDKBN <> 1 GROUP BY SHN_Y.SHNCD, SHN_Y.YOYAKUDT) TMP ON SHN_Y.SHNCD = TMP.SHNCD AND SHN_Y.YOYAKUDT = TMP.YOYAKUDT WHERE SHN_Y.UPDKBN <> 1) SELECT LPAD(WK02.MOYSKBN, 1, 0) || LPAD(WK02.MOYSSTDT, 6, 0) || LPAD(WK02.MOYSRBAN, 3, 0) || RPAD(COALESCE(MOYO.MOYKN, ''), 20, '　') || LPAD(WK02.MOHBSTDT, 8, 0) || LPAD(WEEKDAY(CAST(CAST(WK02.MOHBSTDT AS CHAR) AS DATETIME)) + 1, 1, 0) || LPAD(WK02.MOHBEDDT, 8, 0) || LPAD(WEEKDAY(CAST(CAST(WK02.MOHBEDDT AS CHAR) AS DATETIME)) + 1, 1, 0) || LPAD(COALESCE(CAST(WK02.HBOKUREFLG AS CHAR), ''), 1, '0') || LPAD(COALESCE(CAST(WK02.QADEVSTDT AS CHAR), ''), 8, '0') || LPAD(COALESCE(CAST(WK02.TENGPCD AS CHAR), ''), 3, '0') || LPAD(COALESCE(CAST(WK02.KANRINO AS CHAR), ''), 4, '0') || LPAD(COALESCE(CAST(WK02.KANRIENO AS CHAR), ''), 2, '0') || RPAD(COALESCE(WK02.SHNCD, ''), 14, ' ') || LPAD(COALESCE(CAST(WK02.BMNCD AS CHAR), ''), 3, '0') || LPAD(COALESCE(CAST(ASHN.DAICD AS CHAR), ''), 2, '0') || LPAD(COALESCE(CAST(ASHN.CHUCD AS CHAR), ''), 2, '0') || LPAD(CASE WHEN SHN_Y.SHNCD IS NOT NULL THEN SHN_Y.SHOCD WHEN SHN.SHNCD IS NOT NULL THEN SHN.SHOCD ELSE 0 END, 2, 0) || RPAD(COALESCE(ASHN.PARNO, ''), 3, ' ') || LPAD(COALESCE(CAST(ASHN.CHLDNO AS CHAR), ''), 2, '0') || LPAD(COALESCE(CAST(ASHN.HIGAWRFLG AS CHAR), ''), 1, '0') || RPAD(COALESCE(ASHN.SANCHIKN, ''), 20, '　') || RPAD(COALESCE(ASHN.MAKERKN, ''), 14, '　') || RPAD(COALESCE(ASHN.POPKN, ''), 20, '　') || RPAD(COALESCE(ASHN.KIKKN, ''), 23, '　') || LPAD(COALESCE(CAST(ASHN.SEGN_NINZU AS CHAR), ''), 5, '0') || RPAD(COALESCE(ASHN.SEGN_GENTEI, ''), 10, '　') || LPAD(COALESCE(CAST(ASHN.SEGN_1KOSU AS CHAR), ''), 3, '0') || RPAD(COALESCE(ASHN.SEGN_1KOSUTNI, ''), 5, '　') || LPAD(COALESCE(CAST(ASHN.ADDSHUKBN AS CHAR), ''), 2, '0') || TRIM(LPAD(FLOOR(COALESCE(ASHN.GENKAAM_MAE * 100, 0)), 8, 0)) || TRIM(LPAD(FLOOR(COALESCE(ASHN.GENKAAM_1KG * 100, 0)), 8, 0)) || TRIM(LPAD(FLOOR(COALESCE(ASHN.GENKAAM_PACK * 100, 0)), 9, 0)) || LPAD(COALESCE(CASE WHEN SHN_Y.SHNCD IS NOT NULL THEN SHN_Y.RG_BAIKAAM WHEN SHN.SHNCD IS NOT NULL THEN SHN.RG_BAIKAAM ELSE 0 END, 0), 6, 0) || LPAD(COALESCE(CAST(ASHN.IRISU AS CHAR), ''), 3, '0') || LPAD(COALESCE(CAST(WK02.HBSTDT AS CHAR), ''), 8, '0') || LPAD(WEEKDAY(CAST(CAST(WK02.HBSTDT AS CHAR) AS DATETIME)) + 1, 1, 0) || LPAD(COALESCE(CAST(WK02.HBEDDT AS CHAR), ''), 8, '0') || LPAD(WEEKDAY(CAST(CAST(WK02.HBEDDT AS CHAR) AS DATETIME)) + 1, 1, 0) || LPAD(COALESCE(CAST(ASHN.MEDAMAKBN AS CHAR), ''), 1, '0') || LPAD(COALESCE(CAST(ASHN.POPCD AS CHAR), ''), 10, '0') || RPAD(COALESCE(ASHN.POPSZ, ''), 3, ' ') || LPAD(COALESCE(CAST(ASHN.POPSU AS CHAR), ''), 2, '0') || RPAD(COALESCE(ASHN.SHNSIZE, ''), 40, ' ') || RPAD(COALESCE(ASHN.SHNCOLOR, ''), 20, ' ') || LPAD(COALESCE(CAST(ASHN.NAMANETUKBN AS CHAR), ''), 1, '0') || LPAD(COALESCE(CAST(ASHN.KAITOFLG AS CHAR), ''), 1, '0') || LPAD(COALESCE(CAST(ASHN.YOSHOKUFLG AS CHAR), ''), 1, '0') || LPAD(COALESCE(CAST(WK02.A_BAIKAAM AS CHAR), ''), 6, '0') || LPAD(COALESCE(CAST(WK02.B_BAIKAAM AS CHAR), ''), 6, '0') || LPAD(COALESCE(CAST(WK02.C_BAIKAAM AS CHAR), ''), 6, '0') || LPAD(COALESCE(CAST(WK02.A_GENKAAM_1KG AS CHAR), ''), 6, '0') || LPAD(COALESCE(CAST(WK02.B_GENKAAM_1KG AS CHAR), ''), 6, '0') || LPAD(COALESCE(CAST(WK02.C_GENKAAM_1KG AS CHAR), ''), 6, '0') || LPAD(COALESCE(CAST(ASHN.A_BAIKAAM_PACK AS CHAR), ''), 6, '0') || LPAD(COALESCE(CAST(ASHN.B_BAIKAAM_PACK AS CHAR), ''), 6, '0') || LPAD(COALESCE(CAST(ASHN.C_BAIKAAM_PACK AS CHAR), ''), 6, '0') || LPAD(COALESCE(CAST(WK02.A_WRITUKBN AS CHAR), ''), 1, '0') || LPAD(COALESCE(CAST(WK02.B_WRITUKBN AS CHAR), ''), 1, '0') || LPAD(COALESCE(CAST(WK02.C_WRITUKBN AS CHAR), ''), 1, '0') || LPAD(COALESCE(CAST(ASHN.A_BAIKAAM_100G AS CHAR), ''), 6, '0') || LPAD(COALESCE(CAST(ASHN.B_BAIKAAM_100G AS CHAR), ''), 6, '0') || LPAD(COALESCE(CAST(ASHN.C_BAIKAAM_100G AS CHAR), ''), 6, '0') || LPAD(COALESCE(CAST(ASHN.TKANPLUKBN AS CHAR), ''), 1, '0') || LPAD(COALESCE(CAST(ASHN.YORIFLG AS CHAR), ''), 1, '0') || LPAD(COALESCE(CAST(ASHN.BD1_TENSU AS CHAR), ''), 3, '0') || LPAD(COALESCE(CAST(ASHN.BD2_TENSU AS CHAR), ''), 3, '0') || LPAD(COALESCE(CAST(WK02.KO_A_BAIKAAN AS CHAR), ''), 6, '0') || LPAD(COALESCE(CAST(WK02.BD1_A_BAIKAAN AS CHAR), ''), 6, '0') || LPAD(COALESCE(CAST(WK02.BD2_A_BAIKAAN AS CHAR), ''), 6, '0') || LPAD(COALESCE(CAST(WK02.KO_B_BAIKAAN AS CHAR), ''), 6, '0') || LPAD(COALESCE(CAST(WK02.BD1_B_BAIKAAN AS CHAR), ''), 6, '0') || LPAD(COALESCE(CAST(WK02.BD2_B_BAIKAAN AS CHAR), ''), 6, '0') || LPAD(COALESCE(CAST(WK02.C_WRITUKBN AS CHAR), ''), 6, '0') || LPAD(COALESCE(CAST(WK02.BD1_C_BAIKAAN AS CHAR), ''), 6, '0') || LPAD(COALESCE(CAST(WK02.BD2_C_BAIKAAN AS CHAR), ''), 6, '0') || LPAD(COALESCE(CASE WHEN SHN_Y.SHNCD IS NOT NULL THEN SHN_Y.ZEIKBN WHEN SHN.SHNCD IS NOT NULL THEN SHN.ZEIKBN ELSE 0 END, 0), 1, 0) || LPAD(COALESCE(CASE WHEN SHN_Y.SHNCD IS NOT NULL THEN SHN_Y.ZEIRTKBN WHEN SHN.SHNCD IS NOT NULL THEN SHN.ZEIRTKBN ELSE 0 END, 0), 3, 0) || LPAD(COALESCE(CASE WHEN SHN_Y.SHNCD IS NOT NULL THEN SHN_Y.ZEIRTKBN_OLD WHEN SHN.SHNCD IS NOT NULL THEN SHN.ZEIRTKBN_OLD ELSE 0 END, 0), 3, 0) || LPAD(COALESCE(CASE WHEN SHN_Y.SHNCD IS NOT NULL THEN SHN_Y.ZEIRTHENKODT WHEN SHN.SHNCD IS NOT NULL THEN SHN.ZEIRTHENKODT ELSE 0 END, 0), 8, 0) || RPAD(COALESCE(WK02.SRCCD1, ''), 14, ' ') || RPAD(COALESCE(WK02.SRCCD2, ''), 14, ' ') || LPAD(COALESCE(CAST(WK02.REIDMYKBN AS CHAR), ''), 1, '0') || LPAD(COALESCE(CAST(WK02.LTENSAIFLG AS CHAR), ''), 1, '0') || LPAD(COALESCE(CAST(WK02.ITMSELKBN AS CHAR), ''), 1, '0') || RPAD(COALESCE(CASE WK02.URIASELKBN WHEN 1 THEN 'A' WHEN 2 THEN 'B' WHEN 3 THEN 'C' WHEN 4 THEN 'D' END, ''), 1, ' ') || LPAD('', 6, '0') || LPAD('', 6, '0') || LPAD('', 6, '0') || RPAD(COALESCE(ASHN.COMMENT_POP, ''), 50, '　') || RPAD(COALESCE(ASHN.COMMENT_HGW, ''), 50, '　') || 0 || LPAD(COALESCE(CAST(WK02.UPDKBN AS CHAR), ''), 1, '0') FROM (SELECT MAX(WK02.MOYSCD) as MOYSCD, WK02.MOYSKBN, WK02.MOYSSTDT, WK02.MOYSRBAN, WK02.BMNCD, WK02.KANRINO, WK02.KANRIENO, MAX(WK02.TENCD) as TENCD, MAX(WK02.HBDT) as HBDT, MAX(WK02.BMNO) as BMNO, MAX(WK02.MOHBSTDT) as MOHBSTDT, MAX(WK02.MOHBEDDT) as MOHBEDDT, MAX(WK02.HBOKUREFLG) as HBOKUREFLG, MAX(WK02.JLSTCREDT) as JLSTCREDT, MAX(WK02.QADEVSTDT) as QADEVSTDT, MAX(WK02.QADEVENDFLG) as QADEVENDFLG, WK02.TENGPCD, MAX(WK02.KYOSEIFLG) as KYOSEIFLG, WK02.SHNCD, MAX(WK02.ADDSHUKBN) as ADDSHUKBN, WK02.HBSTDT, MAX(WK02.HBEDDT) as HBEDDT, MAX(WK02.REIDMYKBN) as REIDMYKBN, MAX(WK02.HBSLIDEFLG) as HBSLIDEFLG, MAX(WK02.GENKAAM) as GENKAAM, MAX(WK02.GENKARITU) as GENKARITU, MAX(WK02.A_BAIKAAM) as A_BAIKAAM, MAX(WK02.B_BAIKAAM) as B_BAIKAAM, MAX(WK02.C_BAIKAAM) as C_BAIKAAM, MAX(WK02.A_GENKAAM_1KG) as A_GENKAAM_1KG, MAX(WK02.B_GENKAAM_1KG) as B_GENKAAM_1KG, MAX(WK02.C_GENKAAM_1KG) as C_GENKAAM_1KG, MAX(WK02.A_WRITUKBN) as A_WRITUKBN, MAX(WK02.B_WRITUKBN) as B_WRITUKBN, MAX(WK02.C_WRITUKBN) as C_WRITUKBN, MAX(WK02.TKANPLUKBN) as TKANPLUKBN, MAX(WK02.KO_A_BAIKAAN) as KO_A_BAIKAAN, MAX(WK02.BD1_A_BAIKAAN) as BD1_A_BAIKAAN, MAX(WK02.BD2_A_BAIKAAN) as BD2_A_BAIKAAN, MAX(WK02.KO_B_BAIKAAN) as KO_B_BAIKAAN, MAX(WK02.BD1_B_BAIKAAN) as BD1_B_BAIKAAN, MAX(WK02.BD2_B_BAIKAAN) as BD2_B_BAIKAAN, MAX(WK02.KO_C_BAIKAAN) as KO_C_BAIKAAN, MAX(WK02.BD1_C_BAIKAAN) as BD1_C_BAIKAAN, MAX(WK02.BD2_C_BAIKAAN) as BD2_C_BAIKAAN, MAX(WK02.PLUSNDFLG) as PLUSNDFLG, MAX(WK02.TEIKEIKBN) as TEIKEIKBN, MAX(WK02.SOURCEKBN1) as SOURCEKBN1, MAX(WK02.SRCCD1) as SRCCD1, MAX(WK02.SOURCEKBN2) as SOURCEKBN2, MAX(WK02.SRCCD2) as SRCCD2, MAX(WK02.URICD) as URICD, MAX(WK02.QASYUKBN) as QASYUKBN, MAX(WK02.LTENSAIFLG) as LTENSAIFLG, MAX(WK02.HANKAISIFLG) as HANKAISIFLG, MAX(WK02.TENSAIFLG) as TENSAIFLG, MAX(WK02.URIASELKBN) as URIASELKBN, MAX(WK02.ITMSELKBN) as ITMSELKBN, MAX(WK02.CBAIKA) as CBAIKA, MAX(WK02.SBAIBL1) as SBAIBL1, MAX(WK02.SBAIBL2) as SBAIBL2, MAX(WK02.CBAIKAKG) as CBAIKAKG, MAX(WK02.DATAKBN) as DATAKBN, MAX(WK02.GTSIMECHGKBN) as GTSIMECHGKBN, MAX(WK02.GTSIMEOKFLG) as GTSIMEOKFLG, MAX(WK02.SENDFLG) as SENDFLG, MAX(WK02.UPDKBN) as UPDKBN FROM INAIF.AN_HANBAI_NEQ WK02 GROUP BY WK02.MOYSKBN, WK02.MOYSSTDT, WK02.MOYSRBAN, WK02.BMNCD, WK02.KANRINO, WK02.KANRIENO, WK02.TENGPCD, WK02.SHNCD, WK02.HBSTDT) WK02 INNER JOIN INATK2.TOKMOYCD MOYO ON WK02.MOYSKBN = MOYO.MOYSKBN AND WK02.MOYSSTDT = MOYO.MOYSSTDT AND WK02.MOYSRBAN = MOYO.MOYSRBAN INNER JOIN INATK2.TOKSP_SHN ASHN ON WK02.MOYSKBN = ASHN.MOYSKBN AND WK02.MOYSSTDT = ASHN.MOYSSTDT AND WK02.MOYSRBAN = ASHN.MOYSRBAN AND WK02.BMNCD = ASHN.BMNCD AND WK02.KANRINO = ASHN.KANRINO AND WK02.KANRIENO = ASHN.KANRIENO LEFT OUTER JOIN INAMS2.MSTSHN SHN ON WK02.SHNCD = SHN.SHNCD LEFT OUTER JOIN SHN_Y ON WK02.SHNCD = SHN_Y.SHNCD AND WK02.MOHBSTDT BETWEEN SHN_Y.YOYAKUDT AND SHN_Y.YOYAKUDT2 WHERE WK02.HBSTDT >= (SELECT SBD.DT_INT FROM INAPARM.SYSBATCHDT_TK SBD WHERE SBD.SMODE = 'DAILY') AND WK02.QASYUKBN <> 5 AND WK02.UPDKBN <> 1 ORDER BY WK02.BMNCD, WK02.KANRINO, WK02.KANRIENO, WK02.TENGPCD, SHN_Y.SHNCD IS NULL ASC, SHN_Y.SHNCD, SHN.SHNCD, WK02.SHNCD, WK02.MOHBSTDT, WK02.MOYSKBN, WK02.MOYSSTDT, WK02.MOYSRBAN;
