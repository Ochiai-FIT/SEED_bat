WITH SHN_Y AS (SELECT SHN_Y.*, CASE WHEN TMP.YOYAKUDT2 IS NOT NULL THEN CAST(DATE_FORMAT(CAST(CAST(TMP.YOYAKUDT2 AS CHAR) AS DATETIME) - INTERVAL 1 DAY, '%Y%m%d') AS SIGNED) ELSE 99999999 END AS YOYAKUDT2 FROM INAMS2.MSTSHN_Y SHN_Y INNER JOIN (SELECT SHN_Y.SHNCD, SHN_Y.YOYAKUDT, MAX(SHN_Y2.YOYAKUDT) AS YOYAKUDT2 FROM INAMS2.MSTSHN_Y SHN_Y LEFT OUTER JOIN (SELECT * FROM INAMS2.MSTSHN_Y WHERE UPDKBN <> 1) SHN_Y2 ON SHN_Y.SHNCD = SHN_Y2.SHNCD AND SHN_Y.YOYAKUDT < SHN_Y2.YOYAKUDT WHERE SHN_Y.UPDKBN <> 1 GROUP BY SHN_Y.SHNCD, SHN_Y.YOYAKUDT) TMP ON SHN_Y.SHNCD = TMP.SHNCD AND SHN_Y.YOYAKUDT = TMP.YOYAKUDT WHERE SHN_Y.UPDKBN <> 1) SELECT LPAD(WK01.MOYSKBN, 1, 0) || LPAD(WK01.MOYSSTDT, 6, 0) || LPAD(WK01.MOYSRBAN, 3, 0) || RPAD(COALESCE(MOYO.MOYKN, ''), 20, '　') || LPAD(WK01.MOHBSTDT, 8, 0) || LPAD(WEEKDAY(CAST(CAST(WK01.MOHBSTDT AS CHAR) AS DATETIME)) + 1, 1, 0) || LPAD(WK01.MOHBEDDT, 8, 0) || LPAD(WEEKDAY(CAST(CAST(WK01.MOHBEDDT AS CHAR) AS DATETIME)) + 1, 1, 0) || LPAD(COALESCE(CAST(WK01.HBOKUREFLG AS CHAR), ''), 1, '0') || LPAD(COALESCE(CAST(WK01.QADEVSTDT AS CHAR), ''), 8, '0') || LPAD(COALESCE(CAST(WK01.TENGPCD AS CHAR), ''), 3, '0') || LPAD(COALESCE(CAST(WK01.KANRINO AS CHAR), ''), 4, '0') || LPAD(COALESCE(CAST(WK01.KANRIENO AS CHAR), ''), 2, '0') || RPAD(COALESCE(WK01.SHNCD, ''), 14, ' ') || LPAD(COALESCE(CAST(WK01.BMNCD AS CHAR), ''), 3, '0') || LPAD(COALESCE(CAST(ASHN.DAICD AS CHAR), ''), 2, '0') || LPAD(COALESCE(CAST(ASHN.CHUCD AS CHAR), ''), 2, '0') || LPAD(CASE WHEN SHN_Y.SHNCD IS NOT NULL THEN SHN_Y.SHOCD WHEN SHN.SHNCD IS NOT NULL THEN SHN.SHOCD ELSE 0 END, 2, 0) || RPAD(COALESCE(ASHN.PARNO, ''), 3, ' ') || LPAD(COALESCE(CAST(ASHN.CHLDNO AS CHAR), ''), 2, '0') || LPAD(COALESCE(CAST(ASHN.HIGAWRFLG AS CHAR), ''), 1, '0') || RPAD(COALESCE(ASHN.SANCHIKN, ''), 20, '　') || RPAD(COALESCE(ASHN.MAKERKN, ''), 14, '　') || RPAD(COALESCE(ASHN.POPKN, ''), 20, '　') || RPAD(COALESCE(ASHN.KIKKN, ''), 23, '　') || LPAD(COALESCE(CAST(ASHN.SEGN_NINZU AS CHAR), ''), 5, '0') || RPAD(COALESCE(ASHN.SEGN_GENTEI, ''), 10, '　') || LPAD(COALESCE(CAST(ASHN.SEGN_1KOSU AS CHAR), ''), 3, '0') || RPAD(COALESCE(ASHN.SEGN_1KOSUTNI, ''), 5, '　') || LPAD(COALESCE(CAST(ASHN.ADDSHUKBN AS CHAR), ''), 2, '0') || TRIM(LPAD(FLOOR(COALESCE(ASHN.GENKAAM_MAE * 100, 0)), 8, 0)) || TRIM(LPAD(FLOOR(COALESCE(ASHN.GENKAAM_1KG * 100, 0)), 8, 0)) || TRIM(LPAD(FLOOR(COALESCE(ASHN.GENKAAM_PACK * 100, 0)), 9, 0)) || LPAD(COALESCE(CASE WHEN SHN_Y.SHNCD IS NOT NULL THEN SHN_Y.RG_BAIKAAM WHEN SHN.SHNCD IS NOT NULL THEN SHN.RG_BAIKAAM ELSE 0 END, 0), 6, 0) || LPAD(COALESCE(CAST(ASHN.IRISU AS CHAR), ''), 3, '0') || LPAD(COALESCE(CAST(WK01.HBSTDT AS CHAR), ''), 8, '0') || LPAD(WEEKDAY(CAST(CAST(WK01.HBSTDT AS CHAR) AS DATETIME)) + 1, 1, 0) || LPAD(COALESCE(CAST(WK01.HBEDDT AS CHAR), ''), 8, '0') || LPAD(WEEKDAY(CAST(CAST(WK01.HBEDDT AS CHAR) AS DATETIME)) + 1, 1, 0) || LPAD(COALESCE(CAST(ASHN.MEDAMAKBN AS CHAR), ''), 1, '0') || LPAD(COALESCE(CAST(ASHN.POPCD AS CHAR), ''), 10, '0') || RPAD(COALESCE(ASHN.POPSZ, ''), 3, ' ') || LPAD(COALESCE(CAST(ASHN.POPSU AS CHAR), ''), 2, '0') || RPAD(COALESCE(ASHN.SHNSIZE, ''), 40, ' ') || RPAD(COALESCE(ASHN.SHNCOLOR, ''), 20, ' ') || LPAD(COALESCE(CAST(ASHN.NAMANETUKBN AS CHAR), ''), 1, '0') || LPAD(COALESCE(CAST(ASHN.KAITOFLG AS CHAR), ''), 1, '0') || LPAD(COALESCE(CAST(ASHN.YOSHOKUFLG AS CHAR), ''), 1, '0') || LPAD(COALESCE(CAST(WK01.A_BAIKAAM AS CHAR), ''), 6, '0') || LPAD(COALESCE(CAST(WK01.B_BAIKAAM AS CHAR), ''), 6, '0') || LPAD(COALESCE(CAST(WK01.C_BAIKAAM AS CHAR), ''), 6, '0') || LPAD(COALESCE(CAST(WK01.A_GENKAAM_1KG AS CHAR), ''), 6, '0') || LPAD(COALESCE(CAST(WK01.B_GENKAAM_1KG AS CHAR), ''), 6, '0') || LPAD(COALESCE(CAST(WK01.C_GENKAAM_1KG AS CHAR), ''), 6, '0') || LPAD(COALESCE(CAST(ASHN.A_BAIKAAM_PACK AS CHAR), ''), 6, '0') || LPAD(COALESCE(CAST(ASHN.B_BAIKAAM_PACK AS CHAR), ''), 6, '0') || LPAD(COALESCE(CAST(ASHN.C_BAIKAAM_PACK AS CHAR), ''), 6, '0') || LPAD(COALESCE(CAST(WK01.A_WRITUKBN AS CHAR), ''), 1, '0') || LPAD(COALESCE(CAST(WK01.B_WRITUKBN AS CHAR), ''), 1, '0') || LPAD(COALESCE(CAST(WK01.C_WRITUKBN AS CHAR), ''), 1, '0') || LPAD(COALESCE(CAST(ASHN.A_BAIKAAM_100G AS CHAR), ''), 6, '0') || LPAD(COALESCE(CAST(ASHN.B_BAIKAAM_100G AS CHAR), ''), 6, '0') || LPAD(COALESCE(CAST(ASHN.C_BAIKAAM_100G AS CHAR), ''), 6, '0') || LPAD(COALESCE(CAST(ASHN.TKANPLUKBN AS CHAR), ''), 1, '0') || LPAD(COALESCE(CAST(ASHN.YORIFLG AS CHAR), ''), 1, '0') || LPAD(COALESCE(CAST(ASHN.BD1_TENSU AS CHAR), ''), 3, '0') || LPAD(COALESCE(CAST(ASHN.BD2_TENSU AS CHAR), ''), 3, '0') || LPAD(COALESCE(CAST(WK01.KO_A_BAIKAAN AS CHAR), ''), 6, '0') || LPAD(COALESCE(CAST(WK01.BD1_A_BAIKAAN AS CHAR), ''), 6, '0') || LPAD(COALESCE(CAST(WK01.BD2_A_BAIKAAN AS CHAR), ''), 6, '0') || LPAD(COALESCE(CAST(WK01.KO_B_BAIKAAN AS CHAR), ''), 6, '0') || LPAD(COALESCE(CAST(WK01.BD1_B_BAIKAAN AS CHAR), ''), 6, '0') || LPAD(COALESCE(CAST(WK01.BD2_B_BAIKAAN AS CHAR), ''), 6, '0') || LPAD(COALESCE(CAST(WK01.C_WRITUKBN AS CHAR), ''), 6, '0') || LPAD(COALESCE(CAST(WK01.BD1_C_BAIKAAN AS CHAR), ''), 6, '0') || LPAD(COALESCE(CAST(WK01.BD2_C_BAIKAAN AS CHAR), ''), 6, '0') || LPAD(COALESCE(CASE WHEN SHN_Y.SHNCD IS NOT NULL THEN SHN_Y.ZEIKBN WHEN SHN.SHNCD IS NOT NULL THEN SHN.ZEIKBN ELSE 0 END, 0), 1, 0) || LPAD(COALESCE(CASE WHEN SHN_Y.SHNCD IS NOT NULL THEN SHN_Y.ZEIRTKBN WHEN SHN.SHNCD IS NOT NULL THEN SHN.ZEIRTKBN ELSE 0 END, 0), 3, 0) || LPAD(COALESCE(CASE WHEN SHN_Y.SHNCD IS NOT NULL THEN SHN_Y.ZEIRTKBN_OLD WHEN SHN.SHNCD IS NOT NULL THEN SHN.ZEIRTKBN_OLD ELSE 0 END, 0), 3, 0) || LPAD(COALESCE(CASE WHEN SHN_Y.SHNCD IS NOT NULL THEN SHN_Y.ZEIRTHENKODT WHEN SHN.SHNCD IS NOT NULL THEN SHN.ZEIRTHENKODT ELSE 0 END, 0), 8, 0) || RPAD(COALESCE(WK01.SRCCD1, ''), 14, ' ') || RPAD(COALESCE(WK01.SRCCD2, ''), 14, ' ') || LPAD(COALESCE(CAST(WK01.REIDMYKBN AS CHAR), ''), 1, '0') || LPAD(COALESCE(CAST(WK01.LTENSAIFLG AS CHAR), ''), 1, '0') || CASE COALESCE(WK01.SHOHINSEL, - 1) WHEN 2 THEN '0' ELSE '1' END || RPAD(COALESCE(CASE WK01.BAIKASELKBN WHEN 1 THEN 'A' WHEN 2 THEN 'B' WHEN 3 THEN 'C' WHEN 4 THEN 'D' END, ''), 1, ' ') || LPAD(COALESCE(CAST(CASE WHEN WK01.BAIKASELKBN = 4 THEN WK01.CBAIKA END AS CHAR), ''), 6, '0') || LPAD(COALESCE(CAST(CASE WHEN WK01.BAIKASELKBN = 4 THEN WK01.SBAIBL1 END AS CHAR), ''), 6, '0') || LPAD(COALESCE(CAST(CASE WHEN WK01.BAIKASELKBN = 4 THEN WK01.SBAIBL2 END AS CHAR), ''), 6, '0') || RPAD(COALESCE(ASHN.COMMENT_POP, ''), 50, '　') || RPAD(COALESCE(ASHN.COMMENT_HGW, ''), 50, '　') || 0 || LPAD(COALESCE(CAST(WK01.UPDKBN AS CHAR), ''), 1, '0') FROM (SELECT WK01.MOYSKBN, WK01.MOYSSTDT, WK01.MOYSRBAN, MAX(WK01.BMNO) AS BMNO, MAX(WK01.MOHBSTDT) AS MOHBSTDT, MAX(WK01.MOHBEDDT) AS MOHBEDDT, MAX(WK01.HBOKUREFLG) AS HBOKUREFLG, MAX(WK01.JLSTCREDT) AS JLSTCREDT, MAX(WK01.QADEVSTDT) AS QADEVSTDT, MAX(WK01.QADEVENDFLG) AS QADEVENDFLG, WK01.TENGPCD, MAX(WK01.KYOSEIFLG) AS KYOSEIFLG, WK01.KANRINO, WK01.KANRIENO, WK01.BMNCD, WK01.SHNCD, MAX(WK01.ADDSHUKBN) AS ADDSHUKBN, WK01.HBSTDT, MAX(WK01.HBEDDT) AS HBEDDT, MAX(WK01.REIDMYKBN) AS REIDMYKBN, MAX(WK01.HBSLIDEFLG) AS HBSLIDEFLG, MAX(WK01.GENKAAM) AS GENKAAM, MAX(WK01.GENKARITU) AS GENKARITU, MAX(WK01.A_BAIKAAM) AS A_BAIKAAM, MAX(WK01.B_BAIKAAM) AS B_BAIKAAM, MAX(WK01.C_BAIKAAM) AS C_BAIKAAM, MAX(WK01.A_GENKAAM_1KG) AS A_GENKAAM_1KG, MAX(WK01.B_GENKAAM_1KG) AS B_GENKAAM_1KG, MAX(WK01.C_GENKAAM_1KG) AS C_GENKAAM_1KG, MAX(WK01.A_WRITUKBN) AS A_WRITUKBN, MAX(WK01.B_WRITUKBN) AS B_WRITUKBN, MAX(WK01.C_WRITUKBN) AS C_WRITUKBN, MAX(WK01.TKANPLUKBN) AS TKANPLUKBN, MAX(WK01.KO_A_BAIKAAN) AS KO_A_BAIKAAN, MAX(WK01.BD1_A_BAIKAAN) AS BD1_A_BAIKAAN, MAX(WK01.BD2_A_BAIKAAN) AS BD2_A_BAIKAAN, MAX(WK01.KO_B_BAIKAAN) AS KO_B_BAIKAAN, MAX(WK01.BD1_B_BAIKAAN) AS BD1_B_BAIKAAN, MAX(WK01.BD2_B_BAIKAAN) AS BD2_B_BAIKAAN, MAX(WK01.KO_C_BAIKAAN) AS KO_C_BAIKAAN, MAX(WK01.BD1_C_BAIKAAN) AS BD1_C_BAIKAAN, MAX(WK01.BD2_C_BAIKAAN) AS BD2_C_BAIKAAN, MAX(WK01.PLUSNDFLG) AS PLUSNDFLG, MAX(WK01.TEIKEIKBN) AS TEIKEIKBN, MAX(WK01.SOURCEKBN1) AS SOURCEKBN1, MAX(WK01.SRCCD1) AS SRCCD1, MAX(WK01.SOURCEKBN2) AS SOURCEKBN2, MAX(WK01.SRCCD2) AS SRCCD2, MAX(WK01.URICD) AS URICD, MAX(WK01.TENCD) AS TENCD, MAX(WK01.HBDT1) AS HBDT1, MAX(WK01.HBDT2) AS HBDT2, MAX(WK01.HBDT3) AS HBDT3, MAX(WK01.HBDT4) AS HBDT4, MAX(WK01.HBDT5) AS HBDT5, MAX(WK01.HBDT6) AS HBDT6, MAX(WK01.HBDT7) AS HBDT7, MAX(WK01.HBDT8) AS HBDT8, MAX(WK01.HBDT9) AS HBDT9, MAX(WK01.HBDT10) AS HBDT10, MAX(WK01.QASYUKBN) AS QASYUKBN, MAX(WK01.LTENSAIFLG) AS LTENSAIFLG, MAX(WK01.HANKAISIFLG) AS HANKAISIFLG, MAX(WK01.TENSAIFLG) AS TENSAIFLG, MAX(WK01.BAIKASELKBN) AS BAIKASELKBN, MAX(WK01.SHOHINSEL) AS SHOHINSEL, MAX(WK01.CBAIKA) AS CBAIKA, MAX(WK01.SBAIBL1) AS SBAIBL1, MAX(WK01.SBAIBL2) AS SBAIBL2, MAX(WK01.CBAIKAKG) AS CBAIKAKG, MAX(WK01.DATAKBN) AS DATAKBN, MAX(WK01.GTSIMECHGKBN) AS GTSIMECHGKBN, MAX(WK01.GTSIMEOKFLG) AS GTSIMEOKFLG, MAX(WK01.SENDFLG) AS SENDFLG, MAX(WK01.UPDKBN) AS UPDKBN FROM INAWK.ANWK01_AF WK01 GROUP BY WK01.MOYSKBN, WK01.MOYSSTDT, WK01.MOYSRBAN, WK01.BMNCD, WK01.KANRINO, WK01.KANRIENO, WK01.TENGPCD, WK01.SHNCD, WK01.HBSTDT) WK01 INNER JOIN INATK2.TOKMOYCD MOYO ON WK01.MOYSKBN = MOYO.MOYSKBN AND WK01.MOYSSTDT = MOYO.MOYSSTDT AND WK01.MOYSRBAN = MOYO.MOYSRBAN INNER JOIN INATK2.TOKTG_SHN ASHN ON WK01.MOYSKBN = ASHN.MOYSKBN AND WK01.MOYSSTDT = ASHN.MOYSSTDT AND WK01.MOYSRBAN = ASHN.MOYSRBAN AND WK01.BMNCD = ASHN.BMNCD AND WK01.KANRINO = ASHN.KANRINO AND WK01.KANRIENO = ASHN.KANRIENO LEFT OUTER JOIN INAMS2.MSTSHN SHN ON WK01.SHNCD = SHN.SHNCD LEFT OUTER JOIN SHN_Y ON WK01.SHNCD = SHN_Y.SHNCD AND WK01.MOHBSTDT BETWEEN SHN_Y.YOYAKUDT AND SHN_Y.YOYAKUDT2 WHERE WK01.QASYUKBN <> 5 AND ((WK01.GTSIMECHGKBN IN (1, 2, 4) AND WK01.GTSIMEOKFLG = 1) OR (WK01.GTSIMECHGKBN IN (0, 3) AND WK01.GTSIMEOKFLG = 0)) ORDER BY WK01.BMNCD, WK01.KANRINO, WK01.KANRIENO, WK01.TENGPCD, SHN_Y.SHNCD IS NULL ASC, SHN_Y.SHNCD, SHN.SHNCD, WK01.SHNCD, WK01.MOHBSTDT, WK01.MOYSKBN, WK01.MOYSSTDT, WK01.MOYSRBAN;
