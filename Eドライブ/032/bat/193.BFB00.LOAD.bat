REM [193][BFB00]
@ECHO OFF

REM ログフォルダ作成
IF NOT EXIST %~DP0..\logs MKDIR %~DP0..\logs

REM コマンドフォルダ作成
IF NOT EXIST %~DP0..\cmd MKDIR %~DP0..\cmd

REM ログファイルの情報
SET OUTFILE=%~DP0../logs/setup.log
SET OUTTIME=%~DP0../logs/time.log

REM ベースフォルダ
SET BASEDIR=%~DP0..

REM 更新対象の情報
SET INFOSCRIPT=%~DP0..\cmd\%~N0.DB2


SET MSG=%DATE% %TIME% TRUNCATE INAIN.BFB00
ECHO %MSG%
>> %OUTFILE% ECHO %MSG%
"%MYSQLPATH%mysql" %OPTION% -h %HOST% %DB_NAME% -u %USER_ID% --show-warnings -vv -e "TRUNCATE TABLE INAIN.BFB00 ;commit;" >>%OUTFILE% 2>&1
IF NOT %ERRORLEVEL%==0 GOTO ERROR

rem BFB00_01へ取り込み ======================================================================
SET MSG=%DATE% %TIME% TRUNCATE INAIN.BFB00_01
ECHO %MSG%
>> %OUTFILE% ECHO %MSG%
"%MYSQLPATH%mysql" %OPTION% -h %HOST% %DB_NAME% -u %USER_ID% --show-warnings -vv -e "TRUNCATE TABLE INAIN.BFB00_01 ;commit;">>%OUTFILE% 2>&1
IF NOT %ERRORLEVEL%==0 GOTO ERROR

rem ファイルパスの設定
SET INFILENAME=0193
set filename=DATA\%INFILENAME%
set filename_tmp=%filename:\=\\%

SET MSG=%DATE% %TIME%  →  BFB00_01 LOAD処理
ECHO %MSG%
ECHO %MSG% >> %OUTFILE%
"%MYSQLPATH%mysql" %OPTION% -h %HOST% %DB_NAME% -u %USER_ID% --local_infile=1 --show-warnings -vv -e "load data local infile '%filename_tmp%' IGNORE into table INAIN.BFB00_01 character set cp932 fields terminated by ',' ESCAPED BY '' lines terminated by '\r\n' (@1) SET DATA = @1; commit;" >>%OUTFILE% 2>&1
IF NOT %ERRORLEVEL%==0 GOTO ERROR


rem BFB00へU登録 =========================================================================
SET MSG=%DATE% %TIME%  →  LOAD処理(事前発注対象日付ファイル)
ECHO %MSG%
ECHO %MSG% >> %OUTFILE%
"%MYSQLPATH%mysql" %OPTION% -h %HOST% %DB_NAME% -u %USER_ID% --show-warnings -vv -e "INSERT IGNORE INTO INAIN.BFB00 SELECT MID(DATA, 1, 5) AS COPY, MID(DATA, 6, 3) AS SEQ, MID(DATA, 9, 3) AS BMNCD, MID(DATA, 12, 3) AS TOK, MID(DATA, 15, 3) AS TEI, MID(DATA, 18, 1) AS JIZNUT, MID(DATA, 19, 1) AS NENMAT, MID(DATA, 20, 7) AS FILLER01, MID(DATA, 27, 8) AS SYORIB, MID(DATA, 35, 1) AS YOUBI, MID(DATA, 36, 8) AS TYUKAIS, MID(DATA, 44, 8) AS TYUSYUR, MID(DATA, 52, 8) AS TOKKAIS, MID(DATA, 60, 8) AS TOKSYUR, MID(DATA, 68, 8) AS TDATE01, MID(DATA, 76, 1) AS TYOUBI01, MID(DATA, 77, 8) AS TDATE02, MID(DATA, 85, 1) AS TYOUBI02, MID(DATA, 86, 8) AS TDATE03, MID(DATA, 94, 1) AS TYOUBI03, MID(DATA, 95, 8) AS TDATE04, MID(DATA, 103, 1) AS TYOUBI04, MID(DATA, 104, 8) AS TDATE05, MID(DATA, 112, 1) AS TYOUBI05, MID(DATA, 113, 8) AS TDATE06, MID(DATA, 121, 1) AS TYOUBI06, MID(DATA, 122, 8) AS TDATE07, MID(DATA, 130, 1) AS TYOUBI07, MID(DATA, 131, 8) AS TDATE08, MID(DATA, 139, 1) AS TYOUBI08, MID(DATA, 140, 8) AS TDATE09, MID(DATA, 148, 1) AS TYOUBI09, MID(DATA, 149, 8) AS TDATE10, MID(DATA, 157, 1) AS TYOUBI10, MID(DATA, 158, 8) AS HACKAIS, MID(DATA, 166, 8) AS HACSYUR, MID(DATA, 174, 8) AS HDATE01, MID(DATA, 182, 1) AS HYOUBI01, MID(DATA, 183, 8) AS HDATE02, MID(DATA, 191, 1) AS HYOUBI02, MID(DATA, 192, 8) AS HDATE03, MID(DATA, 200, 1) AS HYOUBI03, MID(DATA, 201, 8) AS HDATE04, MID(DATA, 209, 1) AS HYOUBI04, MID(DATA, 210, 8) AS HDATE05, MID(DATA, 218, 1) AS HYOUBI05, MID(DATA, 219, 8) AS HDATE06, MID(DATA, 227, 1) AS HYOUBI06, MID(DATA, 228, 8) AS HDATE07, MID(DATA, 236, 1) AS HYOUBI07, MID(DATA, 237, 8) AS HDATE08, MID(DATA, 245, 1) AS HYOUBI08, MID(DATA, 246, 8) AS HDATE09, MID(DATA, 254, 1) AS HYOUBI09, MID(DATA, 255, 8) AS HDATE10, MID(DATA, 263, 1) AS HYOUBI10, MID(DATA, 264, 8) AS HDATE11, MID(DATA, 272, 1) AS HYOUBI11, MID(DATA, 273, 8) AS HDATE12, MID(DATA, 281, 1) AS HYOUBI12, MID(DATA, 282, 8) AS HDATE13, MID(DATA, 290, 1) AS HYOUBI13, MID(DATA, 291, 8) AS HDATE14, MID(DATA, 299, 1) AS HYOUBI14, MID(DATA, 300, 8) AS HDATE15, MID(DATA, 308, 1) AS HYOUBI15, MID(DATA, 309, 8) AS HDATE16, MID(DATA, 317, 1) AS HYOUBI16, MID(DATA, 318, 6) AS LISTNO, MID(DATA, 324, 8) AS KOTYUKAB, MID(DATA, 332, 8) AS KOTYUSYUB, MID(DATA, 340, 8) AS SOUSIME, MID(DATA, 348, 8) AS KESKAB, MID(DATA, 356, 8) AS KESSYUB, MID(DATA, 364, 10) AS TITLE, nullif(MID(DATA, 374, 1),' ') AS JZNKSYHKB, MID(DATA, 375, 8) AS SAKSEIB, MID(DATA, 383, 8) AS FILLER02 FROM INAIN.BFB00_01 ; commit ; " >>%OUTFILE% 2>&1
IF NOT %ERRORLEVEL%==0 GOTO ERROR
"%MYSQLPATH%mysql" %OPTION% -h %HOST% %DB_NAME% -u %USER_ID% --show-warnings -vv -e "ANALYZE TABLE INAIN.BFB00;commit;" >>%OUTFILE% 2>&1
IF NOT %ERRORLEVEL%==0 GOTO ERROR

:FINAL
EXIT /B 0

:ERROR
EXIT /B 1
