REM [000][AN_NOUNYU_BFR_NEW]
@ECHO OFF

REM ログフォルダ作成
IF NOT EXIST %~DP0..\logs MKDIR %~DP0..\logs

REM コマンドフォルダ作成
IF NOT EXIST %~DP0..\cmd MKDIR %~DP0..\cmd

REM ログファイルの情報
SET OUTFILE=%~DP0../logs/setup.log
SET OUTTIME=%~DP0../logs/time.log

REM ベースフォルダ
SET BASEDIR=%~DP0..

REM 更新対象の情報
SET INFOSCRIPT=%~DP0..\cmd\%~N0.DB2

SET MSG=%DATE% %TIME% INAIF.AN_NOUNYU_BFR ロード処理（全店特売アンケート有 納入データ(反映前)）※OUTDD2:変更有回答用納入ﾃﾞｰﾀ
ECHO %MSG%
>> %OUTFILE% ECHO %MSG%

"%MYSQLPATH%mysql" %OPTION% -h %HOST% %DB_NAME% -u %USER_ID% --show-warnings -vv -e "INSERT ignore INTO INAIF.AN_NOUNYU_BFR WITH TGTG AS (SELECT * FROM INATK2.TOKTG_TENGP TGTG WHERE TGTG.UPDKBN <> 1), TGTEN AS (SELECT TGTEN.MOYSKBN, TGTEN.MOYSSTDT, TGTEN.MOYSRBAN, TGTEN.TENCD, TGTEN.TENGPCD, TGTG.QASYUKBN, TGTEN.KYOSEIFLG, TGTEN.LDTENKBN FROM INATK2.TOKTG_TEN TGTEN LEFT OUTER JOIN TGTG ON TGTG.MOYSKBN = TGTEN.MOYSKBN AND TGTG.MOYSSTDT = TGTEN.MOYSSTDT AND TGTG.MOYSRBAN = TGTEN.MOYSRBAN AND TGTG.TENGPCD = TGTEN.TENGPCD), TGSHN AS (SELECT WK05_PRE.MOYSCD, WK05_PRE.MOYSKBN, WK05_PRE.MOYSSTDT, WK05_PRE.MOYSRBAN, WK05_PRE.BMNCD, WK05_PRE.KANRINO, WK05_PRE.KANRIENO, WK05_PRE.TENCD, WK05_PRE.NNDT, WK05_PRE.SHUNO, WK05_PRE.TSHUFLG, WK05_PRE.MYOSNNSTDT, WK05_PRE.MYOSNNEDDT, WK05_PRE.NENMATKBN, WK05_PRE.JLSTCREFLG, WK05_PRE.JLSTCREDT, WK05_PRE.JHTSUINDT, WK05_PRE.WEEKHTDT, WK05_PRE.QADEVSTDT, WK05_PRE.QADEVEDFLG, WK05_PRE.TENGPCD, WK05_PRE.KYOSEIFLG, TGSHN.SHNCD, CASE WHEN TGSHN.ADDSHUKBN = 1 THEN 1 ELSE 0 END AS REIDMYKBN, WK05_PRE.NNSTDT, WK05_PRE.NNEDDT, TGSHN.JUFLG, TGSHN.JUHTDT, TGSHN.BINKBN, 0 AS NNSLIDE, TGSHN.CUTTENFLG, TGSHN.SHUDENFLG, WK05_PRE.HSUU, WK05_PRE.HTASU, WK05_PRE.PTNNO, WK05_PRE.TSEIKBN, WK05_PRE.ZJSKFLG, WK05_PRE.NNWEEKHTDT, WK05_PRE.QASYUKBN, WK05_PRE.LDSYFLG, WK05_PRE.MBSYFLG, WK05_PRE.ITMSELKBN, CASE WHEN TGSHN.GTSIMECHGKBN = 3 THEN WK05_PRE.GTSIMECHGKBN ELSE TGSHN.GTSIMECHGKBN END AS GTSIMECHGKBN, CASE WHEN TGSHN.GTSIMECHGKBN = 3 THEN WK05_PRE.GTSIMEOKFLG ELSE TGSHN.GTSIMEOKFLG END AS GTSIMEOKFLG, WK05_PRE.SENDFLG AS SENDFLG, 9 AS UPDKBN, MIN(WK05_PRE.TENCD) OVER (PARTITION BY WK05_PRE.MOYSCD, WK05_PRE.MOYSKBN, WK05_PRE.MOYSSTDT, WK05_PRE.MOYSRBAN, WK05_PRE.BMNCD, WK05_PRE.KANRINO, WK05_PRE.KANRIENO) AS BASE_TENCD, MIN(WK05_PRE.NNDT) OVER (PARTITION BY WK05_PRE.MOYSCD, WK05_PRE.MOYSKBN, WK05_PRE.MOYSSTDT, WK05_PRE.MOYSRBAN, WK05_PRE.BMNCD, WK05_PRE.KANRINO, WK05_PRE.KANRIENO, WK05_PRE.TENCD) AS BASE_NNDT FROM INAPRE.AN_NOUNYU_BFR WK05_PRE INNER JOIN INATK2.TOKTG_SHN TGSHN ON WK05_PRE.MOYSKBN = TGSHN.MOYSKBN AND WK05_PRE.MOYSSTDT = TGSHN.MOYSSTDT AND WK05_PRE.MOYSRBAN = TGSHN.MOYSRBAN AND WK05_PRE.BMNCD = TGSHN.BMNCD AND WK05_PRE.KANRINO = TGSHN.KANRINO AND WK05_PRE.KANRIENO = TGSHN.KANRIENO AND TGSHN.UPDKBN <> 1 AND TGSHN.NNSTDT <> 0 AND TGSHN.SENDFLG <> 1), A11O870 AS (SELECT * FROM TGSHN WHERE NOT EXISTS (SELECT * FROM INAWK.AN_NOUNYU_BFR_TEN WK05TC16 WHERE WK05TC16.MOYSKBN = TGSHN.MOYSKBN AND WK05TC16.MOYSSTDT = TGSHN.MOYSSTDT AND WK05TC16.MOYSRBAN = TGSHN.MOYSRBAN AND WK05TC16.BMNCD = TGSHN.BMNCD AND WK05TC16.KANRINO = TGSHN.KANRINO AND WK05TC16.KANRIENO = TGSHN.KANRIENO) UNION ALL SELECT LPAD(WK05TC16.MOYSKBN, 1, 0) || LPAD(WK05TC16.MOYSSTDT, 6, 0) || LPAD(WK05TC16.MOYSRBAN, 3, 0) AS MOYSCD, WK05TC16.MOYSKBN, WK05TC16.MOYSSTDT, WK05TC16.MOYSRBAN, WK05TC16.BMNCD, WK05TC16.KANRINO, WK05TC16.KANRIENO, WK05TC16.TENCD, WK05TC16.NNDT, TGSHN.SHUNO, TGSHN.TSHUFLG, TGSHN.MYOSNNSTDT, TGSHN.MYOSNNEDDT, TGSHN.NENMATKBN, TGSHN.JLSTCREFLG, TGSHN.JLSTCREDT, TGSHN.JHTSUINDT, COALESCE(TGSHN2.WEEKHTDT, 0) AS WEEKHTDT, TGSHN.QADEVSTDT, TGSHN.QADEVEDFLG, TGSHN.TENGPCD, TGSHN.KYOSEIFLG, TGSHN.SHNCD, TGSHN.REIDMYKBN, TGSHN.NNSTDT, TGSHN.NNEDDT, TGSHN.JUFLG, TGSHN.JUHTDT, TGSHN.BINKBN, CASE WHEN TGSHN2.MOYSCD IS NULL THEN 1 ELSE TGSHN.NNSLIDE END AS NNSLIDE, TGSHN.CUTTENFLG, TGSHN.SHUDENFLG, CASE WHEN TGSHN2.MOYSKBN IS NULL THEN WK05TC16.HSUU WHEN WK05TC16.TENHENKO = 1 THEN WK05TC16.HSUU ELSE TGSHN2.HSUU END AS HSUU, CASE WHEN TGSHN2.MOYSKBN IS NULL THEN WK05TC16.HTASU ELSE WK05TC16.HTASU END HTASU, CASE WHEN TGSHN2.MOYSKBN IS NULL THEN WK05TC16.PTNNO ELSE WK05TC16.PTNNO END PTNNO, CASE WHEN TGSHN2.MOYSKBN IS NULL THEN WK05TC16.TSEIKBN ELSE WK05TC16.TSEIKBN END TSEIKBN, CASE WHEN TGSHN2.MOYSKBN IS NULL THEN WK05TC16.ZJSKFLG ELSE WK05TC16.ZJSKFLG END ZJSKFLG, CASE WHEN TGSHN2.MOYSKBN IS NULL THEN WK05TC16.WEEKHTDT ELSE WK05TC16.WEEKHTDT END NNWEEKHTDT, TGSHN.QASYUKBN, TGSHN.LDSYFLG, TGSHN.MBSYFLG, TGSHN.ITMSELKBN, TGSHN.GTSIMECHGKBN, TGSHN.GTSIMEOKFLG, TGSHN.SENDFLG, TGSHN.UPDKBN, TGSHN.BASE_TENCD, TGSHN.BASE_NNDT FROM INAWK.AN_NOUNYU_BFR_TEN WK05TC16 INNER JOIN TGSHN ON WK05TC16.MOYSKBN = TGSHN.MOYSKBN AND WK05TC16.MOYSSTDT = TGSHN.MOYSSTDT AND WK05TC16.MOYSRBAN = TGSHN.MOYSRBAN AND WK05TC16.BMNCD = TGSHN.BMNCD AND WK05TC16.KANRINO = TGSHN.KANRINO AND WK05TC16.KANRIENO = TGSHN.KANRIENO AND TGSHN.TENCD = TGSHN.BASE_TENCD AND TGSHN.NNDT = TGSHN.BASE_NNDT LEFT OUTER JOIN TGSHN TGSHN0 ON WK05TC16.MOYSKBN = TGSHN0.MOYSKBN AND WK05TC16.MOYSSTDT = TGSHN0.MOYSSTDT AND WK05TC16.MOYSRBAN = TGSHN0.MOYSRBAN AND WK05TC16.BMNCD = TGSHN0.BMNCD AND WK05TC16.KANRINO = TGSHN0.KANRINO AND WK05TC16.KANRIENO = TGSHN0.KANRIENO AND WK05TC16.TENCD = TGSHN0.TENCD AND TGSHN0.NNDT = TGSHN0.BASE_NNDT LEFT OUTER JOIN TGSHN TGSHN2 ON WK05TC16.MOYSKBN = TGSHN2.MOYSKBN AND WK05TC16.MOYSSTDT = TGSHN2.MOYSSTDT AND WK05TC16.MOYSRBAN = TGSHN2.MOYSRBAN AND WK05TC16.BMNCD = TGSHN2.BMNCD AND WK05TC16.KANRINO = TGSHN2.KANRINO AND WK05TC16.KANRIENO = TGSHN2.KANRIENO AND WK05TC16.TENCD = TGSHN2.TENCD AND WK05TC16.NNDT = TGSHN2.NNDT WHERE TGSHN0.MOYSCD IS NOT NULL OR EXISTS (SELECT * FROM (SELECT WK.*, CASE WHEN TGND.TENCHGFLG_ARR = REPEAT('1', 400) THEN 1 ELSE 0 END AS ALL1FLG FROM INAWK.AN_NOUNYU_BFR_TEN WK INNER JOIN INATK2.TOKTG_NNDT TGND ON WK.MOYSKBN = TGND.MOYSKBN AND WK.MOYSSTDT = TGND.MOYSSTDT AND WK.MOYSRBAN = TGND.MOYSRBAN AND WK.BMNCD = TGND.BMNCD AND WK.KANRINO = TGND.KANRINO AND WK.KANRIENO = TGND.KANRIENO AND WK.NNDT = TGND.NNDT AND TGND.SENDFLG <> 1) WK WHERE (WK.HSUU IS NOT NULL OR (WK.TENHENKO IS NOT NULL AND WK.ALL1FLG = 0)) AND WK05TC16.MOYSKBN = WK.MOYSKBN AND WK05TC16.MOYSSTDT = WK.MOYSSTDT AND WK05TC16.MOYSRBAN = WK.MOYSRBAN AND WK05TC16.BMNCD = WK.BMNCD AND WK05TC16.KANRINO = WK.KANRINO AND WK05TC16.KANRIENO = WK.KANRIENO AND WK05TC16.TENCD = WK.TENCD)) SELECT TGSHN.MOYSCD, TGSHN.MOYSKBN, TGSHN.MOYSSTDT, TGSHN.MOYSRBAN, TGSHN.BMNCD, TGSHN.KANRINO, TGSHN.KANRIENO, TGSHN.TENCD, TGSHN.NNDT, MC.SHUNO, MS.TSHUFLG, CASE WHEN FDJ.BMNCD IS NOT NULL THEN MC.NNSTDT_TGF ELSE MC.NNSTDT END AS MYOSNNSTDT, CASE WHEN FDJ.BMNCD IS NOT NULL THEN MC.NNEDDT_TGF ELSE MC.NNEDDT END AS MYOSNNEDDT, MC.NENMATKBN, TGSHN.JLSTCREFLG, TGSHN.JLSTCREDT, TGSHN.JHTSUINDT, TGSHN.WEEKHTDT, TGKHN.QADEVSTDT, TGSHN.QADEVEDFLG, TGTEN.TENGPCD, TGTEN.KYOSEIFLG, TGSHN.SHNCD, TGSHN.REIDMYKBN, TGSHN.NNSTDT, TGSHN.NNEDDT, TGSHN.JUFLG, TGSHN.JUHTDT, TGSHN.BINKBN, TGSHN.NNSLIDE, TGSHN.CUTTENFLG, TGSHN.SHUDENFLG, TGSHN.HSUU, TGSHN.HTASU, TGSHN.PTNNO, TGSHN.TSEIKBN, TGSHN.ZJSKFLG, TGSHN.NNWEEKHTDT, TGTEN.QASYUKBN, TGSHN.LDSYFLG, CASE WHEN TGTEN.LDTENKBN = 0 THEN 1 WHEN TGTEN.LDTENKBN = 1 THEN 2 END AS MBSYFLG, TGSHN.ITMSELKBN, TGSHN.GTSIMECHGKBN, TGSHN.GTSIMEOKFLG, TGSHN.SENDFLG, 0 AS UPDKBN FROM A11O870 TGSHN INNER JOIN INATK2.TOKTG_KHN TGKHN ON TGSHN.MOYSKBN = TGKHN.MOYSKBN AND TGSHN.MOYSSTDT = TGKHN.MOYSSTDT AND TGSHN.MOYSRBAN = TGKHN.MOYSRBAN AND TGKHN.UPDKBN <> 1 INNER JOIN INATK2.TOKMOYCD MC ON TGSHN.MOYSKBN = MC.MOYSKBN AND TGSHN.MOYSSTDT = MC.MOYSSTDT AND TGSHN.MOYSRBAN = MC.MOYSRBAN AND MC.UPDKBN <> 1 INNER JOIN (SELECT * FROM INATK2.TOKMOYSYU MS LEFT OUTER JOIN INAPARM.SYSBATCHDT_TK SBD ON SBD.ACTIVEFLG = 1 WHERE CAST(DATE_FORMAT(SBD.DT - INTERVAL 1 YEAR, '%%y') AS SIGNED) <= SUBSTR(MS.SHUNO, 1, 2) AND SUBSTR(MS.SHUNO, 1, 2) <= CAST(DATE_FORMAT(SBD.DT + INTERVAL 1 YEAR, '%%y') AS SIGNED)) MS ON MS.SHUNO = MC.SHUNO LEFT OUTER JOIN TGTEN ON TGSHN.MOYSKBN = TGTEN.MOYSKBN AND TGSHN.MOYSSTDT = TGTEN.MOYSSTDT AND TGSHN.MOYSRBAN = TGTEN.MOYSRBAN AND TGSHN.TENCD = TGTEN.TENCD LEFT OUTER JOIN INAPARM.PRAM_FRSDRYJUD FDJ ON FDJ.BMNCD = TGSHN.BMNCD AND FDJ.JUDFLG = 'S';COMMIT;" >>%OUTFILE% 2>&1
IF NOT %ERRORLEVEL%==0 GOTO ERROR
"%MYSQLPATH%mysql" %OPTION% -h %HOST% %DB_NAME% -u %USER_ID% --show-warnings -vv -e "ANALYZE TABLE INAIF.AN_NOUNYU_BFR;COMMIT;" >>%OUTFILE% 2>&1
IF NOT %ERRORLEVEL%==0 GOTO ERROR


:FINAL
EXIT /B 0

:ERROR
EXIT /B 1
